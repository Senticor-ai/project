name: CI

on:
  push:
    branches:
      - main
    paths-ignore:
      - infra/k8s/overlays/production/kustomization.yaml
      - CHANGELOG.md
  pull_request:
  workflow_dispatch:

permissions:
  contents: read

env:
  STACKIT_REGISTRY: registry.onstackit.cloud
  STACKIT_IMAGE_PREFIX: registry.onstackit.cloud/senticor/project
  PLAYWRIGHT_BROWSERS_PATH: ~/.cache/ms-playwright
  UV_CACHE_DIR: ~/.cache/uv
  PIP_CACHE_DIR: ~/.cache/pip

concurrency:
  group: ci-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  docs-drift:
    continue-on-error: true
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Check docs drift
        run: bash scripts/check-doc-drift.sh

  backend-migration-policy:
    continue-on-error: true
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: pip
          cache-dependency-path: |
            backend/pyproject.toml
            backend/uv.lock
      - name: Install uv
        run: python -m pip install --upgrade pip uv
      - name: Check migration policy
        run: bash scripts/check-alembic-policy.sh

  frontend-lint:
    continue-on-error: true
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version-file: .node-version
          cache: npm
          cache-dependency-path: frontend/package-lock.json
      - name: Lint frontend
        run: |
          cd frontend
          npm ci --ignore-scripts --silent
          npm run lint

  frontend-typecheck:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version-file: .node-version
          cache: npm
          cache-dependency-path: frontend/package-lock.json
      - name: Typecheck frontend
        run: |
          cd frontend
          npm ci --ignore-scripts --silent
          npm run type-check

  backend-lint:
    continue-on-error: true
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: pip
          cache-dependency-path: |
            backend/pyproject.toml
            backend/uv.lock
      - name: Cache backend uv downloads
        uses: actions/cache@v4
        with:
          path: ${{ env.UV_CACHE_DIR }}
          key: ${{ runner.os }}-uv-backend-${{ hashFiles('backend/uv.lock') }}
          restore-keys: |
            ${{ runner.os }}-uv-backend-
      - name: Install uv
        run: python -m pip install --upgrade pip uv
      - name: Lint backend
        run: |
          cd backend
          uv sync --quiet --all-groups --all-extras
          uv run ruff check .

  backend-typecheck:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: pip
          cache-dependency-path: |
            backend/pyproject.toml
            backend/uv.lock
      - name: Cache backend uv downloads
        uses: actions/cache@v4
        with:
          path: ${{ env.UV_CACHE_DIR }}
          key: ${{ runner.os }}-uv-backend-${{ hashFiles('backend/uv.lock') }}
          restore-keys: |
            ${{ runner.os }}-uv-backend-
      - name: Install uv
        run: python -m pip install --upgrade pip uv
      - name: Typecheck backend
        run: |
          cd backend
          uv sync --quiet --all-groups --all-extras
          uv run mypy app/

  backend-security:
    continue-on-error: true
    runs-on: senticor000-github-runner
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - name: Install uv
        run: python -m pip install --upgrade pip uv
      - name: Audit backend dependencies
        run: |
          cd backend
          uv sync --quiet --all-groups --all-extras
          uv run pip-audit

  agents-lint:
    continue-on-error: true
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: pip
          cache-dependency-path: |
            agents/pyproject.toml
            agents/uv.lock
      - name: Cache agents uv downloads
        uses: actions/cache@v4
        with:
          path: ${{ env.UV_CACHE_DIR }}
          key: ${{ runner.os }}-uv-agents-${{ hashFiles('agents/uv.lock') }}
          restore-keys: |
            ${{ runner.os }}-uv-agents-
      - name: Install uv
        run: python -m pip install --upgrade pip uv
      - name: Lint agents
        run: |
          cd agents
          uv sync --quiet --all-groups
          uv run ruff check .

  agents-typecheck:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: pip
          cache-dependency-path: |
            agents/pyproject.toml
            agents/uv.lock
      - name: Cache agents uv downloads
        uses: actions/cache@v4
        with:
          path: ${{ env.UV_CACHE_DIR }}
          key: ${{ runner.os }}-uv-agents-${{ hashFiles('agents/uv.lock') }}
          restore-keys: |
            ${{ runner.os }}-uv-agents-
      - name: Install uv
        run: python -m pip install --upgrade pip uv
      - name: Typecheck agents
        run: |
          cd agents
          uv sync --quiet --all-groups
          uv run mypy .

  frontend-unit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version-file: .node-version
          cache: npm
          cache-dependency-path: frontend/package-lock.json
      - name: Run frontend unit tests
        run: |
          cd frontend
          npm ci --ignore-scripts --silent
          CI=1 npx vitest run --project=unit

  frontend-unit-coverage:
    # Coverage should not block CI, but failures are still tracked by the
    # CI Failure Tickets workflow.
    continue-on-error: true
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version-file: .node-version
          cache: npm
          cache-dependency-path: frontend/package-lock.json
      - name: Run frontend unit coverage report
        run: |
          cd frontend
          npm ci --ignore-scripts --silent
          CI=1 npx vitest run --project=unit --coverage --coverage.reporter=text --coverage.reporter=cobertura --coverage.reporter=json-summary --coverage.reportsDirectory=coverage/unit
      - name: Upload frontend unit coverage
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: frontend-unit-coverage
          path: frontend/coverage/unit/
          if-no-files-found: ignore

  frontend-storybook:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version-file: .node-version
          cache: npm
          cache-dependency-path: frontend/package-lock.json
      - name: Cache Playwright browsers
        uses: actions/cache@v4
        with:
          path: ${{ env.PLAYWRIGHT_BROWSERS_PATH }}
          key: ${{ runner.os }}-playwright-${{ hashFiles('frontend/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-playwright-
      - name: Install frontend dependencies
        run: |
          cd frontend
          npm ci --silent
      - name: Install Playwright browser for storybook tests
        run: |
          cd frontend
          npx playwright install --with-deps chromium
      - name: Run storybook tests
        run: |
          cd frontend
          STORYBOOK_TESTS=1 CI=1 npx vitest run --project=storybook

  backend-unit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: pip
          cache-dependency-path: |
            backend/pyproject.toml
            backend/uv.lock
      - name: Cache backend uv downloads
        uses: actions/cache@v4
        with:
          path: ${{ env.UV_CACHE_DIR }}
          key: ${{ runner.os }}-uv-backend-${{ hashFiles('backend/uv.lock') }}
          restore-keys: |
            ${{ runner.os }}-uv-backend-
      - name: Install uv
        run: python -m pip install --upgrade pip uv
      - name: Run backend unit tests
        run: |
          cd backend
          uv sync --quiet --all-groups --all-extras
          uv run pytest -m unit -q --maxfail=1

  agents-unit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: pip
          cache-dependency-path: |
            agents/pyproject.toml
            agents/uv.lock
      - name: Cache agents uv downloads
        uses: actions/cache@v4
        with:
          path: ${{ env.UV_CACHE_DIR }}
          key: ${{ runner.os }}-uv-agents-${{ hashFiles('agents/uv.lock') }}
          restore-keys: |
            ${{ runner.os }}-uv-agents-
      - name: Install uv
        run: python -m pip install --upgrade pip uv
      - name: Run agents unit tests
        run: |
          cd agents
          uv sync --quiet
          uv run pytest tests/ -q --ignore=tests/test_dogfooding.py

  agents-dogfooding:
    # Dogfooding tests are informational (non-blocking) until stability is proven
    continue-on-error: true
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: pip
          cache-dependency-path: |
            agents/pyproject.toml
            agents/uv.lock
      - name: Cache agents uv downloads
        uses: actions/cache@v4
        with:
          path: ${{ env.UV_CACHE_DIR }}
          key: ${{ runner.os }}-uv-agents-${{ hashFiles('agents/uv.lock') }}
          restore-keys: |
            ${{ runner.os }}-uv-agents-
      - name: Install uv
        run: python -m pip install --upgrade pip uv
      - name: Run agents dogfooding tests
        run: |
          cd agents
          uv sync --quiet
          uv run pytest tests/test_dogfooding.py -v

  backend-integration:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: project
          POSTGRES_PASSWORD: ci_test_password
          POSTGRES_DB: project
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U project -d project"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    env:
      POSTGRES_USER: project
      POSTGRES_PASSWORD: ci_test_password
      POSTGRES_DB: project
      DATABASE_URL: postgresql://project:ci_test_password@localhost:5432/project
      VITE_API_BASE_URL: http://localhost:8000
      MEILI_URL: ''
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: pip
          cache-dependency-path: |
            backend/pyproject.toml
            backend/uv.lock
      - name: Cache backend uv downloads
        uses: actions/cache@v4
        with:
          path: ${{ env.UV_CACHE_DIR }}
          key: ${{ runner.os }}-uv-backend-${{ hashFiles('backend/uv.lock') }}
          restore-keys: |
            ${{ runner.os }}-uv-backend-
      - name: Install uv
        run: python -m pip install --upgrade pip uv
      - name: Run backend integration tests
        run: |
          cd backend
          uv sync --quiet --all-groups --all-extras
          uv run pytest -m "not unit" -q --maxfail=3 --cov=app --cov-report=term-missing --cov-report=xml:coverage/integration.xml --cov-report=html:coverage/integration
      - name: Upload backend integration coverage
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: backend-integration-coverage
          path: |
            backend/coverage/integration/
            backend/coverage/integration.xml
          if-no-files-found: ignore

  frontend-contract:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: pip
          cache-dependency-path: |
            backend/pyproject.toml
            backend/uv.lock
      - uses: actions/setup-node@v4
        with:
          node-version-file: .node-version
          cache: npm
          cache-dependency-path: frontend/package-lock.json
      - name: Cache backend uv downloads
        uses: actions/cache@v4
        with:
          path: ${{ env.UV_CACHE_DIR }}
          key: ${{ runner.os }}-uv-backend-${{ hashFiles('backend/uv.lock') }}
          restore-keys: |
            ${{ runner.os }}-uv-backend-
      - name: Install uv
        run: python -m pip install --upgrade pip uv
      - name: Run frontend contract tests
        run: |
          cd backend
          uv sync --quiet --all-groups --all-extras
          uv run python scripts/export_schemas.py
          cd ../frontend
          npm ci --ignore-scripts --silent
          CI=1 npx vitest run --project=unit -t "JSON Schema contract"

  push-frontend:
    if: github.event_name == 'push' && github.ref == 'refs/heads/main' && github.actor != 'github-actions[bot]'
    needs:
      - frontend-typecheck
      - backend-typecheck
      - agents-typecheck
      - frontend-unit
      - frontend-storybook
      - backend-unit
      - agents-unit
      - backend-integration
      - frontend-contract
    runs-on: ubuntu-latest
    outputs:
      image_pushed: ${{ steps.push_frontend.outcome == 'success' }}
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3
      - name: Authenticate to StackIT registry
        id: registry_auth
        env:
          STACKIT_REGISTRY_USER: ${{ secrets.STACKIT_REGISTRY_USER }}
          STACKIT_REGISTRY_PASSWORD: ${{ secrets.STACKIT_REGISTRY_PASSWORD }}
        run: |
          REGISTRY_USER="$(printf '%s' "${STACKIT_REGISTRY_USER:-}" | tr -d '\r\n')"
          REGISTRY_PASSWORD="$(printf '%s' "${STACKIT_REGISTRY_PASSWORD:-}" | tr -d '\r\n')"

          if [ -z "${REGISTRY_USER}" ] || [ -z "${REGISTRY_PASSWORD}" ]; then
            echo "::warning::Missing StackIT registry credentials; skipping frontend image push."
            echo "can_push=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          if printf '%s' "${REGISTRY_PASSWORD}" | docker login "${STACKIT_REGISTRY}" --username "${REGISTRY_USER}" --password-stdin; then
            echo "can_push=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "::warning::StackIT registry authentication failed; skipping frontend image push."
          echo "can_push=false" >> "$GITHUB_OUTPUT"
      - name: Build and push frontend image
        id: push_frontend
        if: steps.registry_auth.outputs.can_push == 'true'
        uses: docker/build-push-action@v6
        with:
          context: .
          file: frontend/Dockerfile
          push: true
          tags: ${{ env.STACKIT_IMAGE_PREFIX }}/frontend:${{ github.sha }}
      - name: Skip frontend image push
        if: steps.registry_auth.outputs.can_push != 'true'
        run: echo "Frontend image push skipped because registry authentication was unavailable."

  push-backend:
    if: github.event_name == 'push' && github.ref == 'refs/heads/main' && github.actor != 'github-actions[bot]'
    needs:
      - frontend-typecheck
      - backend-typecheck
      - agents-typecheck
      - frontend-unit
      - frontend-storybook
      - backend-unit
      - agents-unit
      - backend-integration
      - frontend-contract
    runs-on: ubuntu-latest
    outputs:
      image_pushed: ${{ steps.push_backend.outcome == 'success' }}
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3
      - name: Authenticate to StackIT registry
        id: registry_auth
        env:
          STACKIT_REGISTRY_USER: ${{ secrets.STACKIT_REGISTRY_USER }}
          STACKIT_REGISTRY_PASSWORD: ${{ secrets.STACKIT_REGISTRY_PASSWORD }}
        run: |
          REGISTRY_USER="$(printf '%s' "${STACKIT_REGISTRY_USER:-}" | tr -d '\r\n')"
          REGISTRY_PASSWORD="$(printf '%s' "${STACKIT_REGISTRY_PASSWORD:-}" | tr -d '\r\n')"

          if [ -z "${REGISTRY_USER}" ] || [ -z "${REGISTRY_PASSWORD}" ]; then
            echo "::warning::Missing StackIT registry credentials; skipping backend image push."
            echo "can_push=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          if printf '%s' "${REGISTRY_PASSWORD}" | docker login "${STACKIT_REGISTRY}" --username "${REGISTRY_USER}" --password-stdin; then
            echo "can_push=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "::warning::StackIT registry authentication failed; skipping backend image push."
          echo "can_push=false" >> "$GITHUB_OUTPUT"
      - name: Build and push backend image
        id: push_backend
        if: steps.registry_auth.outputs.can_push == 'true'
        uses: docker/build-push-action@v6
        with:
          context: .
          file: backend/Dockerfile
          push: true
          tags: ${{ env.STACKIT_IMAGE_PREFIX }}/backend:${{ github.sha }}
      - name: Skip backend image push
        if: steps.registry_auth.outputs.can_push != 'true'
        run: echo "Backend image push skipped because registry authentication was unavailable."

  push-storybook:
    if: github.event_name == 'push' && github.ref == 'refs/heads/main' && github.actor != 'github-actions[bot]'
    needs:
      - frontend-typecheck
      - backend-typecheck
      - agents-typecheck
      - frontend-unit
      - frontend-storybook
      - backend-unit
      - agents-unit
      - backend-integration
      - frontend-contract
    runs-on: ubuntu-latest
    outputs:
      image_pushed: ${{ steps.push_storybook.outcome == 'success' }}
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3
      - name: Authenticate to StackIT registry
        id: registry_auth
        env:
          STACKIT_REGISTRY_USER: ${{ secrets.STACKIT_REGISTRY_USER }}
          STACKIT_REGISTRY_PASSWORD: ${{ secrets.STACKIT_REGISTRY_PASSWORD }}
        run: |
          REGISTRY_USER="$(printf '%s' "${STACKIT_REGISTRY_USER:-}" | tr -d '\r\n')"
          REGISTRY_PASSWORD="$(printf '%s' "${STACKIT_REGISTRY_PASSWORD:-}" | tr -d '\r\n')"

          if [ -z "${REGISTRY_USER}" ] || [ -z "${REGISTRY_PASSWORD}" ]; then
            echo "::warning::Missing StackIT registry credentials; skipping storybook image push."
            echo "can_push=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          if printf '%s' "${REGISTRY_PASSWORD}" | docker login "${STACKIT_REGISTRY}" --username "${REGISTRY_USER}" --password-stdin; then
            echo "can_push=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "::warning::StackIT registry authentication failed; skipping storybook image push."
          echo "can_push=false" >> "$GITHUB_OUTPUT"
      - name: Build and push storybook image
        id: push_storybook
        if: steps.registry_auth.outputs.can_push == 'true'
        uses: docker/build-push-action@v6
        with:
          context: .
          file: frontend/Dockerfile.storybook
          build-args: |
            STORYBOOK_BASE=/storybook/
          push: true
          tags: ${{ env.STACKIT_IMAGE_PREFIX }}/storybook:${{ github.sha }}
      - name: Skip storybook image push
        if: steps.registry_auth.outputs.can_push != 'true'
        run: echo "Storybook image push skipped because registry authentication was unavailable."

  push-agents:
    if: github.event_name == 'push' && github.ref == 'refs/heads/main' && github.actor != 'github-actions[bot]'
    needs:
      - docs-drift
      - frontend-lint
      - frontend-typecheck
      - backend-lint
      - backend-typecheck
      - agents-lint
      - agents-typecheck
      - backend-migration-policy
      - frontend-unit
      - frontend-storybook
      - backend-unit
      - agents-unit
      - backend-integration
      - frontend-contract
    runs-on: ubuntu-latest
    outputs:
      image_pushed: ${{ steps.push_agents.outcome == 'success' }}
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3
      - name: Authenticate to StackIT registry
        id: registry_auth
        env:
          STACKIT_REGISTRY_USER: ${{ secrets.STACKIT_REGISTRY_USER }}
          STACKIT_REGISTRY_PASSWORD: ${{ secrets.STACKIT_REGISTRY_PASSWORD }}
        run: |
          REGISTRY_USER="$(printf '%s' "${STACKIT_REGISTRY_USER:-}" | tr -d '\r\n')"
          REGISTRY_PASSWORD="$(printf '%s' "${STACKIT_REGISTRY_PASSWORD:-}" | tr -d '\r\n')"

          if [ -z "${REGISTRY_USER}" ] || [ -z "${REGISTRY_PASSWORD}" ]; then
            echo "::warning::Missing StackIT registry credentials; skipping agents image push."
            echo "can_push=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          if printf '%s' "${REGISTRY_PASSWORD}" | docker login "${STACKIT_REGISTRY}" --username "${REGISTRY_USER}" --password-stdin; then
            echo "can_push=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "::warning::StackIT registry authentication failed; skipping agents image push."
          echo "can_push=false" >> "$GITHUB_OUTPUT"
      - name: Build and push agents image
        id: push_agents
        if: steps.registry_auth.outputs.can_push == 'true'
        uses: docker/build-push-action@v6
        with:
          context: .
          file: agents/Dockerfile
          push: true
          tags: ${{ env.STACKIT_IMAGE_PREFIX }}/agents:${{ github.sha }}
      - name: Skip agents image push
        if: steps.registry_auth.outputs.can_push != 'true'
        run: echo "Agents image push skipped because registry authentication was unavailable."

  update-manifests:
    if: github.event_name == 'push' && github.ref == 'refs/heads/main' && github.actor != 'github-actions[bot]' && needs.push-frontend.outputs.image_pushed == 'true' && needs.push-backend.outputs.image_pushed == 'true' && needs.push-storybook.outputs.image_pushed == 'true' && needs.push-agents.outputs.image_pushed == 'true'
    needs:
      - push-frontend
      - push-backend
      - push-storybook
      - push-agents
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Update production image tags for Flux
        run: |
          IMAGE_TAG="${GITHUB_SHA}"
          KUST="infra/k8s/overlays/production/kustomization.yaml"
          CHANGELOG_FILE="CHANGELOG.md"
          RUN_URL="https://github.com/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}"
          TIMESTAMP="$(date -u +"%Y-%m-%d %H:%M:%S UTC")"

          sed -i "s|newName: .*/backend|newName: ${STACKIT_IMAGE_PREFIX}/backend|" "$KUST"
          sed -i "s|newName: .*/frontend|newName: ${STACKIT_IMAGE_PREFIX}/frontend|" "$KUST"
          sed -i "s|newName: .*/storybook|newName: ${STACKIT_IMAGE_PREFIX}/storybook|" "$KUST"
          sed -i "s|newName: .*/agents|newName: ${STACKIT_IMAGE_PREFIX}/agents|" "$KUST"
          sed -i "s/newTag: .*/newTag: \"${IMAGE_TAG}\"/" "$KUST"

          if git diff --quiet -- "$KUST"; then
            echo "No manifest change to commit"
            exit 0
          fi

          if [ ! -f "$CHANGELOG_FILE" ]; then
            {
              echo "# Changelog"
              echo
              echo "Deployment updates written by CI."
            } > "$CHANGELOG_FILE"
          fi

          {
            echo
            echo "## ${TIMESTAMP} - ${IMAGE_TAG}"
            echo
            echo "- Updated \`${KUST}\` image tags to \`${IMAGE_TAG}\`."
            echo "- Workflow run: ${RUN_URL}"
            echo "- Actor: \`${GITHUB_ACTOR}\`"
          } >> "$CHANGELOG_FILE"

          git config user.email "ci@project.dev"
          git config user.name "github-actions[bot]"
          git add "$KUST" "$CHANGELOG_FILE"
          git commit -m "deploy: update image tag to ${IMAGE_TAG} [skip ci]"
          git pull --rebase origin main
          git push origin HEAD:main
