name: CI

on:
  push:
    branches:
      - main
    paths-ignore:
      - infra/k8s/overlays/production/kustomization.yaml
  pull_request:
  workflow_dispatch:

permissions:
  contents: read

env:
  STACKIT_REGISTRY: registry.onstackit.cloud
  STACKIT_IMAGE_PREFIX: registry.onstackit.cloud/senticor/project

concurrency:
  group: ci-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  docs-drift:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Check docs drift
        run: bash scripts/check-doc-drift.sh

  backend-migration-policy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - name: Install uv
        run: python -m pip install --upgrade pip uv
      - name: Check migration policy
        run: bash scripts/check-alembic-policy.sh

  frontend-lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version-file: .node-version
          cache: npm
          cache-dependency-path: frontend/package-lock.json
      - name: Lint frontend
        run: |
          cd frontend
          npm ci --ignore-scripts --silent
          npm run lint

  frontend-typecheck:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version-file: .node-version
          cache: npm
          cache-dependency-path: frontend/package-lock.json
      - name: Typecheck frontend
        run: |
          cd frontend
          npm ci --ignore-scripts --silent
          npm run type-check

  backend-lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - name: Install uv
        run: python -m pip install --upgrade pip uv
      - name: Lint backend
        run: |
          cd backend
          uv sync --quiet --all-groups --all-extras
          uv run ruff check .

  backend-typecheck:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - name: Install uv
        run: python -m pip install --upgrade pip uv
      - name: Typecheck backend
        run: |
          cd backend
          uv sync --quiet --all-groups --all-extras
          uv run mypy app/

  agents-lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - name: Install uv
        run: python -m pip install --upgrade pip uv
      - name: Lint agents
        run: |
          cd agents
          uv sync --quiet --all-groups
          uv run ruff check .

  agents-typecheck:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - name: Install uv
        run: python -m pip install --upgrade pip uv
      - name: Typecheck agents
        run: |
          cd agents
          uv sync --quiet --all-groups
          uv run mypy .

  frontend-unit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version-file: .node-version
          cache: npm
          cache-dependency-path: frontend/package-lock.json
      - name: Run frontend unit tests
        run: |
          cd frontend
          npm ci --ignore-scripts --silent
          CI=1 npx vitest run --project=unit --coverage --coverage.reporter=text --coverage.reporter=cobertura --coverage.reporter=json-summary --coverage.reportsDirectory=coverage/unit
      - name: Upload frontend unit coverage
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: frontend-unit-coverage
          path: frontend/coverage/unit/
          if-no-files-found: ignore

  frontend-storybook:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version-file: .node-version
          cache: npm
          cache-dependency-path: frontend/package-lock.json
      - name: Install frontend dependencies
        run: |
          cd frontend
          npm ci --silent
      - name: Install Playwright browser for storybook tests
        run: |
          cd frontend
          npx playwright install --with-deps chromium
      - name: Run storybook tests
        run: |
          cd frontend
          STORYBOOK_TESTS=1 CI=1 npx vitest run --project=storybook

  backend-unit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - name: Install uv
        run: python -m pip install --upgrade pip uv
      - name: Run backend unit tests
        run: |
          cd backend
          uv sync --quiet --all-groups --all-extras
          uv run pytest -m unit -q --maxfail=1

  agents-unit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - name: Install uv
        run: python -m pip install --upgrade pip uv
      - name: Run agents unit tests
        run: |
          cd agents
          uv sync --quiet
          uv run pytest tests/ -q

  backend-integration:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: project
          POSTGRES_PASSWORD: ci_test_password
          POSTGRES_DB: project
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U project -d project"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    env:
      POSTGRES_USER: project
      POSTGRES_PASSWORD: ci_test_password
      POSTGRES_DB: project
      DATABASE_URL: postgresql://project:ci_test_password@localhost:5432/project
      VITE_API_BASE_URL: http://localhost:8000
      MEILI_URL: ''
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - name: Install uv
        run: python -m pip install --upgrade pip uv
      - name: Run backend integration tests
        run: |
          cd backend
          uv sync --quiet --all-groups --all-extras
          uv run pytest -m "not unit" -q --maxfail=3 --cov=app --cov-report=term-missing --cov-report=xml:coverage/integration.xml --cov-report=html:coverage/integration
      - name: Upload backend integration coverage
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: backend-integration-coverage
          path: |
            backend/coverage/integration/
            backend/coverage/integration.xml
          if-no-files-found: ignore

  frontend-contract:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - uses: actions/setup-node@v4
        with:
          node-version-file: .node-version
          cache: npm
          cache-dependency-path: frontend/package-lock.json
      - name: Install uv
        run: python -m pip install --upgrade pip uv
      - name: Run frontend contract tests
        run: |
          cd backend
          uv sync --quiet --all-groups --all-extras
          uv run python scripts/export_schemas.py
          cd ../frontend
          npm ci --ignore-scripts --silent
          CI=1 npx vitest run --project=unit -t "JSON Schema contract"

  push-frontend:
    if: github.event_name == 'push' && github.ref == 'refs/heads/main' && github.actor != 'github-actions[bot]'
    needs:
      - docs-drift
      - frontend-lint
      - frontend-typecheck
      - backend-lint
      - backend-typecheck
      - agents-lint
      - agents-typecheck
      - backend-migration-policy
      - frontend-unit
      - frontend-storybook
      - backend-unit
      - agents-unit
      - backend-integration
      - frontend-contract
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3
      - uses: docker/login-action@v3
        with:
          registry: ${{ env.STACKIT_REGISTRY }}
          username: ${{ secrets.STACKIT_REGISTRY_USER }}
          password: ${{ secrets.STACKIT_REGISTRY_PASSWORD }}
      - name: Build and push frontend image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: frontend/Dockerfile
          push: true
          tags: ${{ env.STACKIT_IMAGE_PREFIX }}/frontend:${{ github.sha }}

  push-backend:
    if: github.event_name == 'push' && github.ref == 'refs/heads/main' && github.actor != 'github-actions[bot]'
    needs:
      - docs-drift
      - frontend-lint
      - frontend-typecheck
      - backend-lint
      - backend-typecheck
      - agents-lint
      - agents-typecheck
      - backend-migration-policy
      - frontend-unit
      - frontend-storybook
      - backend-unit
      - agents-unit
      - backend-integration
      - frontend-contract
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3
      - uses: docker/login-action@v3
        with:
          registry: ${{ env.STACKIT_REGISTRY }}
          username: ${{ secrets.STACKIT_REGISTRY_USER }}
          password: ${{ secrets.STACKIT_REGISTRY_PASSWORD }}
      - name: Build and push backend image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: backend/Dockerfile
          push: true
          tags: ${{ env.STACKIT_IMAGE_PREFIX }}/backend:${{ github.sha }}

  push-storybook:
    if: github.event_name == 'push' && github.ref == 'refs/heads/main' && github.actor != 'github-actions[bot]'
    needs:
      - docs-drift
      - frontend-lint
      - frontend-typecheck
      - backend-lint
      - backend-typecheck
      - agents-lint
      - agents-typecheck
      - backend-migration-policy
      - frontend-unit
      - frontend-storybook
      - backend-unit
      - agents-unit
      - backend-integration
      - frontend-contract
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3
      - uses: docker/login-action@v3
        with:
          registry: ${{ env.STACKIT_REGISTRY }}
          username: ${{ secrets.STACKIT_REGISTRY_USER }}
          password: ${{ secrets.STACKIT_REGISTRY_PASSWORD }}
      - name: Build and push storybook image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: frontend/Dockerfile.storybook
          build-args: |
            STORYBOOK_BASE=/storybook/
          push: true
          tags: ${{ env.STACKIT_IMAGE_PREFIX }}/storybook:${{ github.sha }}

  update-manifests:
    if: github.event_name == 'push' && github.ref == 'refs/heads/main' && github.actor != 'github-actions[bot]'
    needs:
      - push-frontend
      - push-backend
      - push-storybook
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Update production image tags for Flux
        run: |
          IMAGE_TAG="${GITHUB_SHA}"
          KUST="infra/k8s/overlays/production/kustomization.yaml"

          sed -i "s|newName: .*/backend|newName: ${STACKIT_IMAGE_PREFIX}/backend|" "$KUST"
          sed -i "s|newName: .*/frontend|newName: ${STACKIT_IMAGE_PREFIX}/frontend|" "$KUST"
          sed -i "s|newName: .*/storybook|newName: ${STACKIT_IMAGE_PREFIX}/storybook|" "$KUST"
          sed -i "s/newTag: .*/newTag: \"${IMAGE_TAG}\"/" "$KUST"

          if git diff --quiet -- "$KUST"; then
            echo "No manifest change to commit"
            exit 0
          fi

          git config user.email "ci@project.dev"
          git config user.name "github-actions[bot]"
          git add "$KUST"
          git commit -m "deploy: update image tag to ${IMAGE_TAG} [skip ci]"
          git pull --rebase origin main
          git push origin HEAD:main
