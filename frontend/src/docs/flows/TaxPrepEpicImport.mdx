import { Meta } from "@storybook/addon-docs/blocks";

<Meta title="Flows/Tax Prep/Epic: Import" />

# Epic: Import What You Have

**Status:** Implemented
**Priority:** Done

---

## Context

Users collect tax PDFs throughout the year — W-2, 1099-INT, 1099-DIV, 1099-B,
1098, 1095-A, K-1, charitable receipts, property tax statements, medical expense
records. They need to drag-drop these into COPILOT one by one, then process each.

---

## User Story

> "I have a folder of tax PDFs I've been collecting all year.
> I want to drag-drop them into COPILOT one by one, then process each."

---

## Flow

1. User drops a PDF into the inbox area (FileDropZone overlay appears)
2. File is classified by `intake-classifier` → `DigitalDocument` with MIME-based `encodingFormat`
3. Item metadata created via `POST /items` (optimistic UI, appears instantly)
4. File binary uploaded via chunked API (`initiate` → `uploadChunk` → `complete`)
5. Item PATCHed with `app:fileId` + `app:downloadUrl` linking it to the stored file
6. Backend stores file by UUID — original filename preserved in `FileRecord.original_name` for display

---

## Capability Assessment

| Capability              | Status    | Notes                                                                                  |
| ----------------------- | --------- | -------------------------------------------------------------------------------------- |
| Text capture to inbox   | Works     | `rawCapture` field via InboxCapture                                                    |
| PDF drag-drop to inbox  | **Works** | FileDropZone overlay + `useCaptureFile` in ActionList                                  |
| Chunked file upload API | Works     | `FilesApi.initiate()` + `uploadChunk()` + `complete()`                                 |
| File→Thing linking      | **Works** | `app:fileId` + `app:downloadUrl` in `additionalProperty`; `BaseEntity.fileId` in model |
| Drag to reference/focus | Works     | `@dnd-kit` drag handles on ReferenceRow; Focus is a drop target in BucketNav           |

---

## Implementation Details

**Key files:**

- `frontend/src/lib/file-upload.ts` — standalone `uploadFile()` async function (chunked)
- `frontend/src/hooks/use-mutations.ts` — `useCaptureFile`: create → upload → PATCH pipeline
- `frontend/src/lib/intake-classifier.ts` — classifies files by MIME/extension
- `frontend/src/lib/item-serializer.ts` — `fromJsonLd`/`toJsonLd` extract and serialize `app:fileId`
- `frontend/src/components/work/ActionList.tsx` — FileDropZone integration with document-level drag detection
- `backend/app/models.py` — `DigitalDocument` accepted via `ReferenceItemJsonLd` discriminator

**Error tolerance:** Upload and PATCH failures are caught and tolerated — item metadata
always persists even if the binary upload fails. The link can be retried later.

---

## Schema.org Fit

Each imported file becomes a `DigitalDocument` (subtype of `CreativeWork`) with
`encodingFormat: "application/pdf"` and `app:fileId` pointing to the backend's
UUID-based file storage. The `download_url` provides the retrieval path.

---

## Remaining Gaps

| Capability                      | Status  | Notes                                              |
| ------------------------------- | ------- | -------------------------------------------------- |
| File preview/thumbnail in inbox | **Gap** | No visual indicator that item has an attached file |
| Download link in item detail    | **Gap** | `downloadUrl` stored but no UI to open/download    |
| Link reference to project       | **Gap** | References have no `projectIds` field              |
| Copilot auto-classification     | **Gap** | Needs AI extraction pipeline                       |

---

## Copilot Automation Potential

When a PDF is dropped, Copilot could parse the document via an AI pipeline, identify
the IRS form type, and auto-populate the name and tags.
