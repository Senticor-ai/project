import { Meta } from "@storybook/addon-docs/blocks";
import { Mermaid } from "../../components/docs/Mermaid";

<Meta title="Flows/Tax Prep/Epic: Project-Reference Linking" />

# Epic: Project-Reference Linking

**Status:** Not started
**Priority:** Current

---

## Context

After importing and triaging tax PDFs, each document lives in the reference
bucket â€” but with no project link. The user created a "2025 Tax Return" project
with actions like "Download W-2" and "Download 1099-INT", and those actions can
belong to the project. But the actual PDF documents (references) cannot.

The split-on-triage flow already works: triaging a DigitalDocument from inbox to
an action bucket creates a ReadAction (in the target bucket) + a DigitalDocument
reference (in the reference bucket). The ReadAction gets `app:projectRefs` from
the triage result, but the reference copy does not.

**Result:** The ReadAction says "read this document" and belongs to the project.
The document itself floats unlinked in the global reference list.

---

## User Story

> "I triaged my W-2 PDF to reference and assigned it to my 2025 Tax Return
> project. I want to see all my tax documents listed under that project,
> alongside the actions."

---

## Flow

Three paths to project-reference linking:

<Mermaid chart={`flowchart TD
    A["PDF in inbox"] --> B{"Triage to..."}
    B -- "Action bucket (next/waiting)" --> C["Split-on-triage"]
    C --> D["ReadAction in target bucket\\nâœ… gets projectId"]
    C --> E["DigitalDocument in reference\\nâŒ loses projectId"]
    B -- "Reference bucket" --> F["buildTriagePatch"]
    F --> G["CreativeWork in reference\\nâŒ drops projectId"]

    H["Later: ReferenceRow editor"] --> I["Assign project via picker\\nâœ… works (new)"]

    E -.->|"fix needed"| J["Reference gets projectId"]
    G -.->|"fix needed"| J
    I --> J
    J --> K["ProjectTree shows\\nfile chips under project"]

    style D fill:#e8f5e9,stroke:#2e7d32
    style E fill:#fce4ec,stroke:#c62828
    style G fill:#fce4ec,stroke:#c62828
    style I fill:#e8f5e9,stroke:#2e7d32
    style J fill:#e3f2fd,stroke:#1976d2
    style K fill:#e3f2fd,stroke:#1976d2

`} />

**Path A â€” Triage with project (during triage):**
The project picker already appears in the triage options for action buckets.
It should also appear for the reference bucket (optional). When set, both
the ReadAction and the DigitalDocument reference inherit the project.

**Path B â€” Assign project later (inline editor):**
In the reference list, expand a ReferenceRow â†’ inline ItemEditor shows the
project picker. User selects a project â†’ reference is linked.

**Path C â€” View in ProjectTree:**
When viewing the project tab, each project shows its actions AND its
reference files as compact chips below the action list.

---

## Visual Sketches

### ProjectTree with file chips

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â–¶ 2025 Tax Return                     5     â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚   â”‚ â—‹ Download W-2 from employer        â˜…  â”‚
â”‚   â”‚ â—‹ Download 1099-INT from Schwab        â”‚
â”‚   â”‚ â— Download 1099-DIV from Vanguard  âœ“   â”‚
â”‚   â”‚                                         â”‚
â”‚   â”‚ ðŸ“„ W-2 Form.pdf                        â”‚
â”‚   â”‚ ðŸ“„ 1099-DIV Vanguard.pdf               â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

- Actions listed first (with complete/focus controls)
- Reference files shown below as compact rows: file icon + name
- Count badge includes both: 3 actions + 2 references = 5

### ReferenceRow with project badge

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â‰¡  ðŸ“„ W-2 Form.pdf    triaged  pdf  2025 Tax Return â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

- Project badge appears as a small pill (same style as origin badge)
- Only shown when the reference belongs to a project

---

## Capability Assessment

| Capability                     | Status    | Notes                                                                     |
| ------------------------------ | --------- | ------------------------------------------------------------------------- |
| `ReferenceMaterial.projectIds` | **Gap**   | Type has no `projectIds` field                                            |
| Serialization round-trip       | **Gap**   | `fromJsonLd`/`toJsonLd` don't handle `app:projectRefs` for refs           |
| `buildTriagePatch` (reference) | **Gap**   | Line 409: drops `result.projectId`                                        |
| `buildNewFileReferenceJsonLd`  | **Gap**   | Split reference copy: no `app:projectRefs` emitted                        |
| Project picker in triage       | Partial   | Works for action buckets, not shown for reference                         |
| Project picker in ReferenceRow | **Gap**   | `referenceToEditorValues` returns no `projectId`; no projects prop        |
| ProjectTree shows references   | **Gap**   | Only renders `ActionItem[]`                                               |
| Project badge on ReferenceRow  | **Gap**   | No visual indicator of which project a reference belongs to               |
| Backend PATCH support          | **Works** | `additionalProperty` accepts any `propertyID` including `app:projectRefs` |

---

## Schema.org Fit

`app:projectRefs` is already used on Actions via `additionalProperty`. The same
mechanism works for CreativeWork â€” it's just a PropertyValue with a list of
canonical IDs. No new schema concepts needed.

```json
{
  "@type": "CreativeWork",
  "additionalProperty": [
    {
      "@type": "PropertyValue",
      "propertyID": "app:bucket",
      "value": "reference"
    },
    {
      "@type": "PropertyValue",
      "propertyID": "app:projectRefs",
      "value": ["urn:copilot:project:abc"]
    }
  ]
}
```

---

## Implementation Scope

### Data model

- Add `projectIds: CanonicalId[]` to `ReferenceMaterial` interface
- Update `createReferenceMaterial` factory

### Serialization (3 fixes)

- `fromJsonLd`: extract `app:projectRefs` in CreativeWork + DigitalDocument reference branches
- `toJsonLd`: serialize `projectIds` as `app:projectRefs` in reference branch
- `buildTriagePatch`: include `app:projectRefs` when target is "reference"
- `buildNewFileReferenceJsonLd`: propagate project from source item to split reference

### UI (3 components)

- `ProjectTree`: accept `references` prop, render compact file chips per project
- `ReferenceRow`: accept `projects` prop, show project badge, update editor values
- `ReferenceList` / `BucketView` / `ConnectedBucketView`: thread `projects` prop

---

## Copilot Automation Potential

Copilot could auto-assign references to the correct project based on content:

> "I see you uploaded a 1099-INT from Schwab. Your '2025 Tax Return' project
> has an action 'Download 1099-INT from Schwab'. Want me to link this
> document to that project?"

This requires the project-reference linking to be in place first â€” Copilot needs
the `app:projectRefs` field on CreativeWork to write to.
