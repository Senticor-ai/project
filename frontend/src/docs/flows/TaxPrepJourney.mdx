import { Meta } from "@storybook/addon-docs/blocks";
import { Mermaid } from "../../components/docs/Mermaid";

<Meta title="Flows/Tax Prep/Overview" />

# Flow: Tax Prep ‚Üí CPA Handoff

This document traces a real-world use case through project: preparing
US federal tax documents (tax year 2025) for handoff to a CPA. It maps each
phase against current capabilities, schema.org model fit, FRBR applicability,
and Tay AI agent potential.

---

## Overview

<Mermaid
  chart={`flowchart TD
    A["Drop PDFs into Inbox\\n(W-2, 1099s, 1098, etc.)"] --> B["Triage & Label\\n(IRS form type + schedule)"]
    B --> C{"Have the doc?"}
    C -- "Yes (PDF attached)" --> D["Reference: Extract Fields\\n(box values, amounts)"]
    C -- "No (still needed)" --> E["Next Action:\\nDownload from account"]
    E --> F["Download PDF\\n+ attach to item"]
    F --> D
    D --> G{"Corrected version\\nissued?"}
    G -- "Yes" --> H["New FRBR Expression\\n(keep both, mark current)"]
    H --> D
    G -- "No" --> I["Tax Organizer\\n(project table view)"]
    I --> J["Export: Summary + Files\\n(CSV/PDF + ZIP)"]
    J --> K["Handoff to CPA"]`}
/>

---

## Phases at a Glance

| #   | Phase                   | Epic                                                                      | Status    |
| --- | ----------------------- | ------------------------------------------------------------------------- | --------- |
| 1   | Import What You Have    | [Epic ‚Üí](?path=/docs/flows-tax-prep-epic-import--docs)                    | **Works** |
| 2   | Triage & Label          | [Epic ‚Üí](?path=/docs/flows-tax-prep-epic-triage-label--docs)              | Partial   |
| 2b  | Project-Reference Link  | [Epic ‚Üí](?path=/docs/flows-tax-prep-epic-project-reference-linking--docs) | **Gap**   |
| 3   | Identify Missing Docs   | [Epic ‚Üí](?path=/docs/flows-tax-prep-epic-missing-docs--docs)              | Works     |
| 4   | Download & Attach       | _(below)_                                                                 | **Gap**   |
| 5   | Extract Key Details     | _(below)_                                                                 | **Gap**   |
| 6   | Tax Organizer           | _(below)_                                                                 | **Gap**   |
| 7   | Export & Handoff to CPA | _(below)_                                                                 | **Gap**   |

---

## Phase 4: Download & Attach Missing Docs

**User story**: "I log into Ally Bank, download the 1099-INT PDF, and want
to attach it to the reference item I'll create from this action."

**Flow**:

1. Work through next actions list
2. Download PDF from each account
3. Complete the action ‚Üí create a reference item with the PDF attached
4. Link the reference to the tax project

| Capability                         | Status  | Notes                                                |
| ---------------------------------- | ------- | ---------------------------------------------------- |
| Next action list                   | Works   | ActionList component                                 |
| File upload                        | Works   | Chunked upload API + `uploadFile()` helper           |
| File‚ÜíThing linking                 | Works   | `app:fileId` + `app:downloadUrl` on items            |
| Attach file to reference item      | **Gap** | No UI to attach file to existing reference           |
| Complete action ‚Üí create reference | **Gap** | No `Action.result` linking to resulting CreativeWork |

**Schema.org fit**: `Action.result` is a standard schema.org property that
points to the thing produced by completing the action. TAY could use this
to link "Download 1099-INT" (Action) ‚Üí "1099-INT from Ally" (CreativeWork).

---

## Phase 5: Extract Key Details

**User story**: "For each document, I want to record the key amounts. My CPA
needs to see gross wages from the W-2, interest amounts from the 1099-INT, etc."

**Example data to extract**:

| Document            | Field                | Box    | Amount     |
| ------------------- | -------------------- | ------ | ---------- |
| W-2 (Employer A)    | Gross wages          | Box 1  | $85,000    |
| W-2 (Employer A)    | Federal tax withheld | Box 2  | $18,200    |
| W-2 (Employer A)    | State wages          | Box 16 | $85,000    |
| 1099-INT (Schwab)   | Interest income      | Box 1  | $1,247.33  |
| 1099-INT (Ally)     | Interest income      | Box 1  | $892.18    |
| 1099-DIV (Vanguard) | Ordinary dividends   | Box 1a | $3,450.00  |
| 1099-DIV (Vanguard) | Qualified dividends  | Box 1b | $2,890.00  |
| 1098 (Mortgage Co)  | Mortgage interest    | Box 1  | $12,350.00 |
| 1098 (Mortgage Co)  | Property taxes       | Box 10 | $4,200.00  |

| Capability                  | Status  | Notes                                         |
| --------------------------- | ------- | --------------------------------------------- |
| Free-text description       | Works   | Can put amounts in description field          |
| Structured key-value fields | **Gap** | PropertyValue model supports it, no UI editor |
| MonetaryAmount type         | **Gap** | schema.org has it, TAY doesn't use it         |
| Table/grid view             | **Gap** | No columnar view for structured data          |

**Schema.org fit**: Tax amounts map to PropertyValue with a `tax:` namespace:

```json
{
  "@type": "PropertyValue",
  "propertyID": "tax:w2:box1",
  "name": "Gross wages",
  "value": {
    "@type": "MonetaryAmount",
    "value": 85000,
    "currency": "USD"
  }
}
```

This is valid JSON-LD with schema.org extensibility. PropertyValue is already
the carrier for all app-specific data in TAY. The gap is purely UI.

**What Tay could do**: This is the **highest-value AI capability**. An AI pipeline
parses the PDF, identifies IRS form layout, and extracts box values. Tay
populates PropertyValues automatically:

> "I found your W-2 from Employer A. Gross wages: $85,000, Federal tax
> withheld: $18,200. Does this look right?"

User confirms ‚Üí structured data attached to the reference item.

---

## Phase 6: Tax Organizer (Project View)

**User story**: "I want to see all my tax documents in one table with their
key amounts. This IS the tax organizer my CPA needs."

**Desired view**:

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Tax Prep 2025                                    12/15 docs ‚úì      ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ Document    ‚îÇ Issuer   ‚îÇ Schedule ‚îÇ Key Amount‚îÇ Status   ‚îÇ File    ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ W-2         ‚îÇ Acme Inc ‚îÇ 1040     ‚îÇ $85,000   ‚îÇ ‚úì Have   ‚îÇ üìÑ PDF  ‚îÇ
‚îÇ 1099-INT    ‚îÇ Schwab   ‚îÇ Sch B    ‚îÇ $1,247    ‚îÇ ‚úì Have   ‚îÇ üìÑ PDF  ‚îÇ
‚îÇ 1099-INT    ‚îÇ Ally     ‚îÇ Sch B    ‚îÇ $892      ‚îÇ ‚úì Have   ‚îÇ üìÑ PDF  ‚îÇ
‚îÇ 1099-DIV    ‚îÇ Vanguard ‚îÇ Sch B    ‚îÇ $3,450    ‚îÇ ‚úì Have   ‚îÇ üìÑ PDF  ‚îÇ
‚îÇ 1098        ‚îÇ Wells F  ‚îÇ Sch A    ‚îÇ $12,350   ‚îÇ ‚úì Have   ‚îÇ üìÑ PDF  ‚îÇ
‚îÇ K-1         ‚îÇ XYZ LP   ‚îÇ Sch E    ‚îÇ ‚Äî         ‚îÇ ‚è≥ Wait  ‚îÇ ‚Äî       ‚îÇ
‚îÇ Charitable  ‚îÇ Red Cross‚îÇ Sch A    ‚îÇ $500      ‚îÇ ‚úì Have   ‚îÇ üìÑ PDF  ‚îÇ
‚îÇ ...         ‚îÇ          ‚îÇ          ‚îÇ           ‚îÇ          ‚îÇ         ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ Totals      ‚îÇ          ‚îÇ          ‚îÇ           ‚îÇ          ‚îÇ         ‚îÇ
‚îÇ Wages: $85,000  Interest: $2,139  Dividends: $3,450               ‚îÇ
‚îÇ Deductions: $17,050                                                ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

| Capability               | Status  | Notes                                                 |
| ------------------------ | ------- | ----------------------------------------------------- |
| Reference list           | Works   | ReferenceList shows CreativeWork items                |
| Project-scoped filtering | **Gap** | All bucket views are global; no project filter        |
| Table/columnar view      | **Gap** | Only card-based list view                             |
| Column configuration     | **Gap** | No way to choose which PropertyValues show as columns |
| Aggregation/totals       | **Gap** | No sum/count logic                                    |

---

## Phase 7: Export & Handoff to CPA

**User story**: "I want to export everything: a summary document listing all
forms with their key amounts, plus a ZIP of all the PDFs organized by schedule."

**Export package**:

```
tax-prep-2025/
‚îú‚îÄ‚îÄ tax-organizer-2025.csv      # Summary with all fields
‚îú‚îÄ‚îÄ tax-organizer-2025.pdf      # Formatted summary
‚îú‚îÄ‚îÄ schedule-a/
‚îÇ   ‚îú‚îÄ‚îÄ 1098-wells-fargo.pdf
‚îÇ   ‚îú‚îÄ‚îÄ charitable-red-cross.pdf
‚îÇ   ‚îî‚îÄ‚îÄ medical-receipts.pdf
‚îú‚îÄ‚îÄ schedule-b/
‚îÇ   ‚îú‚îÄ‚îÄ 1099-int-schwab.pdf
‚îÇ   ‚îú‚îÄ‚îÄ 1099-int-ally.pdf
‚îÇ   ‚îî‚îÄ‚îÄ 1099-div-vanguard.pdf
‚îú‚îÄ‚îÄ schedule-e/
‚îÇ   ‚îî‚îÄ‚îÄ k-1-xyz-partners.pdf
‚îî‚îÄ‚îÄ income/
    ‚îî‚îÄ‚îÄ w2-acme-inc.pdf
```

| Capability                 | Status  | Notes                                             |
| -------------------------- | ------- | ------------------------------------------------- |
| JSON export API            | Exists  | `GET /items/export?format=json` (not wired to UI) |
| CSV export API             | Exists  | `GET /items/export?format=csv` (not wired to UI)  |
| Formatted PDF export       | **Gap** | No report generation                              |
| File bundling (ZIP)        | **Gap** | No file download/bundling endpoint                |
| Organized folder structure | **Gap** | No schedule-based file organization               |

**What Tay could do**: Generate the tax organizer summary and organize files:

> "Your tax organizer is ready. 15 documents across 5 schedules. Total wages:
> $85,000. Total interest: $2,139. Total itemized deductions: $17,050.
> Download the package?"

---

## FRBR: Why It Matters for Tax Documents

### The Corrected Document Problem

Tax documents get corrected and re-issued. This is common:

- Broker issues 1099-B in February ‚Üí **corrected** 1099-B in March (adjusted cost basis)
- Employer issues W-2 ‚Üí **W-2c** (corrected wage statement)
- Health marketplace issues 1095-A ‚Üí corrected 1095-A
- Partnership issues K-1 ‚Üí **revised K-1** (sometimes months later)

You need **both versions** in the system:

- The original (for provenance ‚Äî "what did I file with initially?")
- The corrected (for accuracy ‚Äî "what's the actual number?")
- A clear marker of which is current

### FRBR Models This Naturally

<Mermaid chart={`
graph TD
  W["<b>Work</b><br/>1099-INT from Schwab for TY2025"]

E1["<b>Expression 1</b><br/>Original (issued Jan 31, 2026)"]
M1["Manifestation: PDF"]
I1["schwab-1099-int-original.pdf"]

E2["<b>Expression 2</b> ‚Üê CURRENT<br/>Corrected (issued Mar 15, 2026)"]
M2["Manifestation: PDF"]
I2["schwab-1099-int-corrected.pdf"]

W --> E1
W --> E2
E1 --> M1 --> I1
E2 --> M2 --> I2

style W fill:#e3f2fd,stroke:#1976d2,stroke-width:2px
style E1 fill:#f5f5f5,stroke:#999
style E2 fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
style I1 fill:#fff,stroke:#ccc
style I2 fill:#fff,stroke:#ccc
`} />

**Provenance tracks** when the correction arrived and which version the CPA
should use. If the IRS questions a filing, you can show the full version
history.

### Also Useful for Tax Law References

Internal Revenue Code sections follow the FRBR hierarchy naturally:

```
Work:         IRC ¬ß 170 (Charitable Contributions)
Expression:   IRC ¬ß 170, as amended through 2025
Manifestation: ¬ß 170(b)(1)(A) ‚Äî 60% AGI limitation
Item:          Downloaded PDF of IRS Publication 526
```

### Recommendation

Use FRBR for **all** tax documents (personal and law references):

- **Personal docs**: Work = abstract form type per issuer per year.
  Expression = each version (original, corrected). This handles W-2c,
  corrected 1099s, revised K-1s naturally.
- **Law references**: Work = code section. Expression = year-specific version.
  Link personal docs to law sections via `TypedReference.refers_to`.

---

## Schema.org Model Scorecard

| Aspect                      | Fit           | Notes                                                        |
| --------------------------- | ------------- | ------------------------------------------------------------ |
| Documents as CreativeWork   | **Excellent** | `name`, `url`, `encodingFormat`, `description` all natural   |
| Tasks as Action             | **Excellent** | `startTime`, `endTime`, `location`, `result` all relevant    |
| Project container           | **Good**      | `Project` with `desiredOutcome` + child actions works        |
| Delegation                  | **Good**      | `delegatedTo` + waiting bucket is clean                      |
| Financial amounts           | **Poor**      | No `MonetaryAmount` usage; no structured numeric fields      |
| Document issuer             | **Poor**      | No `Organization` entity; issuers are just free text         |
| Document versioning (FRBR)  | **Excellent** | Expression hierarchy handles corrections naturally           |
| Document status (have/need) | **Fair**      | Action‚ÜíCreativeWork lifecycle works but no `result` link     |
| Cross-doc dependencies      | **Good**      | `TypedReference` covers `depends_on`, `refers_to`, `part_of` |
| IRS form vocabulary         | **Fair**      | `keywords` works for tags; no formal vocabulary              |
| Custom domain fields        | **Fair**      | PropertyValue extensible but no UI; `tax:` namespace works   |

---

## Tay Automation Matrix

| Capability                     | User Value    | Infrastructure Ready?                               |
| ------------------------------ | ------------- | --------------------------------------------------- |
| PDF parsing ‚Üí field extraction | **Very High** | Partially ‚Äî pypdf for text extraction, no pipeline  |
| Auto-categorize IRS form type  | High          | No ‚Äî needs classifier model                         |
| Generate tax organizer table   | **Very High** | No ‚Äî no table view, no aggregation                  |
| Completeness check             | High          | No ‚Äî no project-scoped review step                  |
| Export formatted package       | High          | No ‚Äî no file bundling, no PDF report                |
| Suggest missing documents      | Medium        | No ‚Äî no prior-year analysis                         |
| FRBR version detection         | Medium        | No ‚Äî no comparison logic for corrected docs         |

**Highest-leverage Tay feature**: PDF upload ‚Üí text extraction ‚Üí structured
PropertyValues with IRS box numbers and amounts. Needs an AI extraction pipeline.

---

## Living E2E Scoreboard

The journey test suite is the **development guide** for this flow. Each phase
maps to a `test.describe` block in the E2E spec. Tests marked `test.fixme()`
represent features that haven't been built yet ‚Äî they show as "skipped" in CI
and turn green as epics ship.

```bash
npm run test:e2e:journey   # Run against full stack (backend + DB)
```

| Phase          | Tests  | Green  | Skipped | Blocking epic              |
| -------------- | ------ | ------ | ------- | -------------------------- |
| 1 Import       | 3      | 3      | 0       | ‚Äî                          |
| 2 Triage       | 3      | 3      | 0       | ‚Äî                          |
| 2b ProjectRefs | 6      | 6      | 0       | ‚Äî                          |
| 3 MissingDocs  | 3      | 3      | 0       | ‚Äî                          |
| 4 Attach       | 3      | 1      | 2       | Action.result, file-attach |
| 5 Extract      | 2      | 0      | 2       | PropertyValue editor       |
| 6 Organizer    | 2      | 0      | 2       | project-scoped table       |
| 7 Export       | 2      | 0      | 2       | CSV export, ZIP bundle     |
| **Total**      | **24** | **16** | **8**   |                            |

---

## Build Roadmap

### Layer 1: Data Flow

Make documents flow from inbox to organized project.

1. ~~**File‚ÜíThing linking**~~ ‚Äî Done. `app:fileId` + `app:downloadUrl` on BaseEntity
2. ~~**PDF drag-drop to inbox**~~ ‚Äî Done. FileDropZone + `useCaptureFile` uploads binary
3. **Project-reference linking** ‚Äî [Epic ‚Üí](?path=/docs/flows-tax-prep-epic-project-reference-linking--docs) ‚Äî `app:projectRefs` on CreativeWork, ProjectTree file chips
4. **Project-scoped filtering** ‚Äî filter any bucket view by project

### Layer 2: Structured Data

Make tax amounts and categories visible and editable.

4. **PropertyValue editor** ‚Äî add/edit custom key-value pairs on any item
5. **Tag filtering** ‚Äî filter lists by keywords (IRS form types)
6. **Table view for references** ‚Äî columnar display (the tax organizer)

### Layer 3: Document Versioning

Handle corrected and re-issued documents.

7. **FRBR Expressions** ‚Äî version tracking for corrected docs (W-2c, corrected 1099s)
8. **Provenance UI** ‚Äî visual version history showing original vs. corrected

### Layer 4: AI Pipeline

Let Tay parse and categorize documents.

9. **PDF extraction pipeline** ‚Äî PDF ‚Üí text + layout ‚Üí field identification
10. **IRS form classifier** ‚Äî recognize form type from content
11. **Box value extraction** ‚Äî pull amounts into PropertyValues automatically

### Layer 5: Full Journey

Complete the CPA handoff experience.

12. **Tax organizer export** ‚Äî CSV/PDF summary with all fields
13. **File bundling** ‚Äî ZIP with PDFs organized by schedule
14. **Action.result linking** ‚Äî connect completed action to resulting reference
15. **Project templates** ‚Äî "Tax Prep 2025" as a reusable starting point
