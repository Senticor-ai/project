import { Meta } from "@storybook/addon-docs/blocks";

<Meta title="Engineering/Ontology" />

# Overview

The core data model lives in `frontend/src/model/` and uses **schema.org as the primary ontology**.
App-specific concepts that have no schema.org equivalent use `additionalProperty`
([PropertyValue](https://schema.org/PropertyValue)) to scopilot within the schema.org vocabulary.

**Deep dives:**

| Page                                                                                                  | Scope                                                  |
| ----------------------------------------------------------------------------------------------------- | ------------------------------------------------------ |
| [Schema.org Vocabulary](?path=/docs/engineering-ontology-schema-org-vocabulary--docs)                 | Full catalog of schema.org types available to the app  |
| [FRBR Knowledge Graph](?path=/docs/engineering-ontology-frbr-knowledge-graph--docs)                   | Document hierarchy for the knowledge graph projection  |
| [LexCEL Architecture](?path=/docs/engineering-ontology-lexcel-architecture--docs)                     | Typed references, ports, and rule layer                |
| [Legal Reference Normalization](?path=/docs/engineering-ontology-legal-reference-normalization--docs) | Citation parsing and normalization                     |
| [Schema Contract Validation](?path=/docs/engineering-ontology-schema-contract-validation--docs)       | Backend API schemas, AJV contract tests, CI validation |

---

## Schema.org-First Principle

Every entity is stored as **JSON-LD** using a schema.org `@type`. Custom fields that have no schema.org equivalent
go into `additionalProperty` as `PropertyValue` objects rather than inventing a parallel type system.

**Why?** Schema.org is the most widely adopted structured data vocabulary. Using it as
the primary ontology makes the data self-describing, interoperable, and queryable by
any tool that understands schema.org — including search engines, knowledge graphs, and LLMs.

**Rule of thumb:** If schema.org has a property for it, use the schema.org property.
Only use `additionalProperty` when schema.org genuinely has no equivalent.

---

## Intake Classification

Items are classified at capture time using heuristics (Layer 1 + 2). All items land in
`bucket: "inbox"` with `needsEnrichment: true` and `confidence: "medium"`. The user
confirms or overrides the type during triage.

**Implementation:** `frontend/src/lib/intake-classifier.ts` — pure-function classifier
with MIME-to-type lookup table and extension fallback.

### Heuristic rules

| Capture method             | `@type`           | `captureSource.kind` | Notes                                       |
| -------------------------- | ----------------- | -------------------- | ------------------------------------------- |
| Typed text                 | `Action`          | `thought`            | Default — user is expressing intent to do   |
| URL paste (full URL input) | `CreativeWork`    | `url`                | Detected when entire input is `https://...` |
| File drop (PDF, DOCX, ...) | `DigitalDocument` | `file`               | MIME-based with extension fallback          |
| File drop (.eml, .msg)     | `EmailMessage`    | `file`               | Extractable: Person, Organization           |
| File drop (.vcf)           | `DigitalDocument` | `file`               | Extractable: Person, Organization           |
| File drop (.ics)           | `DigitalDocument` | `file`               | Extractable: Event, Person                  |
| Unknown file type          | `DigitalDocument` | `file`               | Fallback for unrecognized MIME/extension    |

### Extractable entities

Structured files carry an `extractableEntities` hint in `additionalProperty` for
downstream enrichment that can create linked entities from a single file capture:

| File type      | `extractableEntities`        | Example                                             |
| -------------- | ---------------------------- | --------------------------------------------------- |
| `.eml`, `.msg` | `["Person", "Organization"]` | Sender, receiver, their organizations               |
| `.vcf`         | `["Person", "Organization"]` | Contact person + their org, may create two entities |
| `.ics`         | `["Event", "Person"]`        | Calendar event + attendees                          |

### CaptureSource variants

**File:** `frontend/src/model/types.ts`

```typescript
type CaptureSource =
  | { kind: "thought" } // typed text
  | { kind: "email"; subject?: string; from?: string } // email integration
  | { kind: "meeting"; title?: string; date?: string } // meeting note
  | { kind: "voice"; transcript?: string } // voice capture
  | { kind: "import"; source: string } // bulk import
  | { kind: "file"; fileName: string; mimeType: string } // file drop/upload
  | { kind: "url"; url: string }; // URL paste
```

### Serialization functions

| Function                  | Input                         | `@type`            | Use case                            |
| ------------------------- | ----------------------------- | ------------------ | ----------------------------------- |
| `buildNewInboxJsonLd`     | raw text                      | `Action`           | Text capture (default)              |
| `buildNewUrlInboxJsonLd`  | URL string                    | `CreativeWork`     | URL paste detected in text          |
| `buildNewFileInboxJsonLd` | `IntakeClassification` + name | per classification | File drop/upload                    |
| `buildNewActionJsonLd`    | text + bucket                 | `Action`           | Direct action creation (skip inbox) |

---

## Entity Types and Buckets

### Type hierarchy

```
schema:Action          (text capture, actionable items)
schema:Project         (desired outcome + child actions)
schema:CreativeWork    (URL paste, reference material after triage)
schema:DigitalDocument (file drop — PDF, DOCX, images, vCard, calendar)
schema:EmailMessage    (email file drop — .eml, .msg)
schema:Event           (calendar entry with date/time/duration)
```

### Inbox is a view, not a type

The **inbox** is a logical filter — it shows items that have not yet been triaged.
There is no `InboxItem` type. Inbox items are entities of any `@type` where
`app:bucket = "inbox"` and typically `needsEnrichment = true`.

Items in the inbox already have a heuristic `@type` from capture. For example,
typed text creates an `Action` in the inbox; dropping a PDF creates a `DigitalDocument`
in the inbox. Both sit there until the user triages them to their final bucket.

### Type specialization summary

| `@type`           | When it applies                                       | Bucket(s)                                             |
| ----------------- | ----------------------------------------------------- | ----------------------------------------------------- |
| `Action`          | Typed text capture, or actionable attributes assigned | `inbox` / `next` / `waiting` / `calendar` / `someday` |
| `DigitalDocument` | File drop (PDF, DOCX, images, vCard, calendar)        | `inbox` (before triage)                               |
| `EmailMessage`    | Email file drop (.eml, .msg)                          | `inbox` (before triage)                               |
| `CreativeWork`    | URL paste, or has content type after triage           | `inbox` / `reference`                                 |
| `Project`         | Has a desired outcome and contains child actions      | `project`                                             |
| `Event`           | Has a specific date/time and duration                 | `calendar`                                            |

### Type detection flow

1. **At capture (heuristic):** Typed text → `Action`. URL paste → `CreativeWork`. File drop → `DigitalDocument` / `EmailMessage` (MIME-based). All land in `bucket: "inbox"`.
2. **During triage:** The user confirms or changes the type. An `Action` in inbox might become a `Project`; a `DigitalDocument` might be triaged to `reference` as a `CreativeWork`.
3. **Through enrichment:** Structured files (`.vcf`, `.ics`, `.eml`) can extract linked entities (Person, Organization, Event) while preserving the original file as a reference.

---

## Canonical IDs

**File**: `frontend/src/model/canonical-id.ts`

Every entity gets a stable URN-style identifier:

```
urn:app:{entity-type}:{uuid}
```

| Entity Type | Example                          |
| ----------- | -------------------------------- |
| `inbox`     | `urn:app:inbox:a1b2c3d4-...`     |
| `action`    | `urn:app:action:e5f6a7b8-...`    |
| `project`   | `urn:app:project:c3d4e5f6-...`   |
| `reference` | `urn:app:reference:b8c9d0e1-...` |
| `context`   | `urn:app:context:c9d0e1f2-...`   |
| `tag`       | `urn:app:tag:d0e1f2a3-...`       |

### API

```typescript
createCanonicalId("inbox", "abc-123"); // → "urn:app:inbox:abc-123"
parseCanonicalId("urn:app:project:xyz"); // → { entityType: "project", uuid: "xyz" }
```

---

## Property Mapping

### Direct schema.org properties

These map 1:1 to schema.org and appear as flat fields on the JSON-LD object:

| Frontend field         | JSON-LD property  | schema.org type                                     | Notes                                                                     |
| ---------------------- | ----------------- | --------------------------------------------------- | ------------------------------------------------------------------------- |
| `name`                 | `name`            | [name](https://schema.org/name)                     | Optional for ActionItem; required for Project, ReferenceMaterial, Context |
| `description`          | `description`     | [description](https://schema.org/description)       | All entities                                                              |
| `tags`                 | `keywords`        | [keywords](https://schema.org/keywords)             | Array of strings                                                          |
| `provenance.createdAt` | `dateCreated`     | [dateCreated](https://schema.org/dateCreated)       | ISO 8601                                                                  |
| `provenance.updatedAt` | `dateModified`    | [dateModified](https://schema.org/dateModified)     | ISO 8601                                                                  |
| `scheduledDate`        | `startTime`       | [startTime](https://schema.org/startTime)           | Actions (schema.org Action property)                                      |
| `completedAt`          | `endTime`         | [endTime](https://schema.org/endTime)               | Completed Actions and Projects                                            |
| `url`                  | `url`             | [url](https://schema.org/url)                       | CreativeWork, URL inbox captures                                          |
| `encodingFormat`       | `encodingFormat`  | [encodingFormat](https://schema.org/encodingFormat) | MIME type for files and references                                        |
| `date`                 | `startDate`       | [startDate](https://schema.org/startDate)           | Event start (ISO 8601)                                                    |
| (end)                  | `endDate`         | [endDate](https://schema.org/endDate)               | Event end (ISO 8601)                                                      |
| `duration`             | `duration`        | [duration](https://schema.org/duration)             | Event duration (minutes or ISO 8601 duration)                             |
| (location)             | `location`        | [location](https://schema.org/location)             | Event location (text)                                                     |
| `projectIds`           | `app:projectRefs` | `additionalProperty`                                | ActionItem → Project(s), many-to-many                                     |

### Custom via `additionalProperty`

These have no schema.org equivalent and are stored as `PropertyValue` objects:

| Frontend field        | `propertyID`              | Value type                                                             |
| --------------------- | ------------------------- | ---------------------------------------------------------------------- |
| `bucket`              | `app:bucket`              | `"inbox"` \| `"next"` \| `"waiting"` \| `"calendar"` \| `"someday"`    |
| `rawCapture`          | `app:rawCapture`          | string                                                                 |
| `isFocused`           | `app:isFocused`           | boolean                                                                |
| `confidence`          | `app:confidence`          | `"low"` \| `"medium"` \| `"high"`                                      |
| `needsEnrichment`     | `app:needsEnrichment`     | boolean                                                                |
| `energyLevel`         | `app:energyLevel`         | `"low"` \| `"medium"` \| `"high"`                                      |
| `sequenceOrder`       | `app:sequenceOrder`       | number                                                                 |
| `delegatedTo`         | `app:delegatedTo`         | string                                                                 |
| `contexts`            | `app:contexts`            | CanonicalId[]                                                          |
| `captureSource`       | `app:captureSource`       | CaptureSource object (see above)                                       |
| `origin`              | `app:origin`              | `"triaged"` \| `"captured"` \| `"file"`                                |
| `dueDate`             | `app:dueDate`             | ISO date string                                                        |
| `startDate`           | `app:startDate`           | ISO date string                                                        |
| `scheduledTime`       | `app:scheduledTime`       | HH:MM string                                                           |
| `desiredOutcome`      | `app:desiredOutcome`      | string                                                                 |
| `status` (project)    | `app:projectStatus`       | `"active"` \| `"completed"` \| `"on-hold"` \| `"archived"`             |
| `projectIds`          | `app:projectRefs`         | CanonicalId[] (many-to-many)                                           |
| `reviewDate`          | `app:reviewDate`          | ISO date string                                                        |
| `ports`               | `app:ports`               | Port[]                                                                 |
| `typedReferences`     | `app:typedReferences`     | TypedReference[]                                                       |
| `archivedAt`          | `app:archivedAt`          | ISO timestamp                                                          |
| `provenanceHistory`   | `app:provenanceHistory`   | ProvenanceEntry[]                                                      |
| `extractableEntities` | `app:extractableEntities` | string[] (e.g. `["Person", "Organization"]`) — file captures only      |
| (server-managed)      | `app:nameProvenance`      | `{ setBy: "user" \| "ai" \| "system", setAt: string, source: string }` |
| `recurrence`          | `app:recurrence`          | RecurrencePattern object                                               |

---

## Entity Hierarchy

### Base Entity (`BaseEntity`)

All entities share these fields:

| Field             | Type               | Origin                                                  |
| ----------------- | ------------------ | ------------------------------------------------------- |
| `id`              | `CanonicalId`      | FRBR/ELI canonical IDs                                  |
| `name`            | `string?`          | schema.org `name` — optional for capture-first entities |
| `description`     | `string?`          | schema.org `description`                                |
| `tags`            | `string[]`         | schema.org `keywords`                                   |
| `references`      | `TypedReference[]` | LexCEL typed renvoi                                     |
| `captureSource`   | `CaptureSource`    | LexCEL evidence anchors                                 |
| `provenance`      | `Provenance`       | LexCEL append-only provenance                           |
| `ports`           | `Port[]`           | LexCEL ports                                            |
| `needsEnrichment` | `boolean`          | FRBR evidence-first                                     |
| `confidence`      | `ConfidenceLevel`  | FRBR evidence-first                                     |

### Entity Types

| `@type`           | TypeScript type                     | Bucket(s)                                             | Key additional fields                                                 |
| ----------------- | ----------------------------------- | ----------------------------------------------------- | --------------------------------------------------------------------- |
| `Action`          | `ActionItem`                        | `inbox` / `next` / `waiting` / `calendar` / `someday` | `contexts`, `isFocused`, `delegatedTo`, `recurrence`, `sequenceOrder` |
| `DigitalDocument` | `ActionItem`                        | `inbox` (before triage)                               | `rawCapture` (set to `name` by `fromJsonLd` fallback)                 |
| `EmailMessage`    | `ActionItem`                        | `inbox` (before triage)                               | `rawCapture`, `extractableEntities` via additionalProperty            |
| `CreativeWork`    | `ActionItem` or `ReferenceMaterial` | `inbox` or `reference`                                | `url`, `encodingFormat`                                               |
| `Project`         | `Project`                           | `project`                                             | `desiredOutcome`, `status`                                            |
| `Event`           | `CalendarEntry`                     | `calendar`                                            | `date`, `time`, `duration`, `isAllDay`                                |

Note: `DigitalDocument` and `EmailMessage` are deserialized by `fromJsonLd`'s fallback branch
as `ActionItem` with `bucket: "inbox"`. `CreativeWork` in inbox is also deserialized as `ActionItem`.
After triage to `reference` bucket, `CreativeWork` becomes `ReferenceMaterial`.

---

## JSON-LD Examples

### Text capture — `Action` in inbox

User typed a string. The heuristic sets `@type: "Action"` because the user is expressing
intent to do something. `name` is **not set** — the raw input lives in `app:rawCapture`.

```json
{
  "@id": "urn:app:inbox:def-456",
  "@type": "Action",
  "_schemaVersion": 2,
  "dateCreated": "2026-02-07T08:00:00Z",
  "dateModified": "2026-02-07T08:00:00Z",
  "startTime": null,
  "endTime": null,
  "additionalProperty": [
    { "@type": "PropertyValue", "propertyID": "app:bucket", "value": "inbox" },
    {
      "@type": "PropertyValue",
      "propertyID": "app:rawCapture",
      "value": "Fahrkosten Müller prüfen"
    },
    {
      "@type": "PropertyValue",
      "propertyID": "app:needsEnrichment",
      "value": true
    },
    {
      "@type": "PropertyValue",
      "propertyID": "app:confidence",
      "value": "medium"
    },
    {
      "@type": "PropertyValue",
      "propertyID": "app:captureSource",
      "value": { "kind": "thought" }
    }
  ]
}
```

### URL capture — `CreativeWork` in inbox

User pasted a URL. The classifier detects it and sets `@type: "CreativeWork"` with
`captureSource.kind: "url"`. Still in inbox until triaged.

```json
{
  "@id": "urn:app:inbox:url-789",
  "@type": "CreativeWork",
  "_schemaVersion": 2,
  "url": "https://www.gesetze-im-internet.de/sgb_3/__159.html",
  "dateCreated": "2026-02-07T08:05:00Z",
  "dateModified": "2026-02-07T08:05:00Z",
  "additionalProperty": [
    { "@type": "PropertyValue", "propertyID": "app:bucket", "value": "inbox" },
    {
      "@type": "PropertyValue",
      "propertyID": "app:needsEnrichment",
      "value": true
    },
    {
      "@type": "PropertyValue",
      "propertyID": "app:confidence",
      "value": "medium"
    },
    {
      "@type": "PropertyValue",
      "propertyID": "app:captureSource",
      "value": {
        "kind": "url",
        "url": "https://www.gesetze-im-internet.de/sgb_3/__159.html"
      }
    }
  ]
}
```

### File capture — `DigitalDocument` in inbox

User dropped a PDF. The classifier detects the MIME type and sets `@type: "DigitalDocument"`.

```json
{
  "@id": "urn:app:inbox:file-101",
  "@type": "DigitalDocument",
  "_schemaVersion": 2,
  "name": "Reisekostenabrechnung_Q1.pdf",
  "encodingFormat": "application/pdf",
  "dateCreated": "2026-02-07T08:10:00Z",
  "dateModified": "2026-02-07T08:10:00Z",
  "additionalProperty": [
    { "@type": "PropertyValue", "propertyID": "app:bucket", "value": "inbox" },
    {
      "@type": "PropertyValue",
      "propertyID": "app:needsEnrichment",
      "value": true
    },
    {
      "@type": "PropertyValue",
      "propertyID": "app:confidence",
      "value": "medium"
    },
    {
      "@type": "PropertyValue",
      "propertyID": "app:captureSource",
      "value": {
        "kind": "file",
        "fileName": "Reisekostenabrechnung_Q1.pdf",
        "mimeType": "application/pdf"
      }
    }
  ]
}
```

### Email file capture — `EmailMessage` in inbox with extractable entities

User dropped a `.eml` file. The classifier flags extractable Person/Organization entities.

```json
{
  "@id": "urn:app:inbox:file-102",
  "@type": "EmailMessage",
  "_schemaVersion": 2,
  "name": "Re_Fahrkosten_Mueller.eml",
  "encodingFormat": "message/rfc822",
  "dateCreated": "2026-02-07T08:15:00Z",
  "dateModified": "2026-02-07T08:15:00Z",
  "additionalProperty": [
    { "@type": "PropertyValue", "propertyID": "app:bucket", "value": "inbox" },
    {
      "@type": "PropertyValue",
      "propertyID": "app:needsEnrichment",
      "value": true
    },
    {
      "@type": "PropertyValue",
      "propertyID": "app:confidence",
      "value": "medium"
    },
    {
      "@type": "PropertyValue",
      "propertyID": "app:captureSource",
      "value": {
        "kind": "file",
        "fileName": "Re_Fahrkosten_Mueller.eml",
        "mimeType": "message/rfc822"
      }
    },
    {
      "@type": "PropertyValue",
      "propertyID": "app:extractableEntities",
      "value": ["Person", "Organization"]
    }
  ]
}
```

### Action (`Action`) — triaged

After triage from inbox, `confidence` is `"high"`, `needsEnrichment` is `false`,
and `bucket` has moved to an action bucket.

```json
{
  "@id": "urn:app:action:abc-123",
  "@type": "Action",
  "_schemaVersion": 2,
  "description": "Reisekostenabrechnung vom 15.11.2025 nachverfolgen",
  "dateCreated": "2026-02-01T10:30:00Z",
  "dateModified": "2026-02-05T14:22:00Z",
  "startTime": "2026-02-10",
  "keywords": ["dringend"],
  "additionalProperty": [
    { "@type": "PropertyValue", "propertyID": "app:bucket", "value": "next" },
    {
      "@type": "PropertyValue",
      "propertyID": "app:rawCapture",
      "value": "Frau Müller wegen Fahrkosten anrufen"
    },
    { "@type": "PropertyValue", "propertyID": "app:isFocused", "value": true },
    {
      "@type": "PropertyValue",
      "propertyID": "app:energyLevel",
      "value": "low"
    },
    {
      "@type": "PropertyValue",
      "propertyID": "app:confidence",
      "value": "high"
    },
    {
      "@type": "PropertyValue",
      "propertyID": "app:needsEnrichment",
      "value": false
    },
    {
      "@type": "PropertyValue",
      "propertyID": "app:contexts",
      "value": ["urn:app:context:phone"]
    },
    {
      "@type": "PropertyValue",
      "propertyID": "app:projectRefs",
      "value": ["urn:app:project:xyz-789"]
    }
  ]
}
```

### Project (`Project`)

```json
{
  "@id": "urn:app:project:xyz-789",
  "@type": "Project",
  "_schemaVersion": 2,
  "name": "Reisekostenabrechnungen Q1 bearbeiten",
  "description": "Alle Q1-Fahrkostenanträge geprüft und abgelegt",
  "dateCreated": "2026-01-15T09:00:00Z",
  "dateModified": "2026-02-05T14:22:00Z",
  "additionalProperty": [
    {
      "@type": "PropertyValue",
      "propertyID": "app:bucket",
      "value": "project"
    },
    {
      "@type": "PropertyValue",
      "propertyID": "app:desiredOutcome",
      "value": "Alle Q1-Anträge abgerechnet"
    },
    {
      "@type": "PropertyValue",
      "propertyID": "app:projectStatus",
      "value": "active"
    },
    { "@type": "PropertyValue", "propertyID": "app:isFocused", "value": false }
  ]
}
```

### Reference material (`CreativeWork`)

```json
{
  "@id": "urn:app:reference:b8c9d0e1",
  "@type": "CreativeWork",
  "_schemaVersion": 2,
  "name": "SGB III § 159 - Ruhen bei Sperrzeit",
  "url": "https://www.gesetze-im-internet.de/sgb_3/__159.html",
  "encodingFormat": "text/html",
  "dateCreated": "2026-02-03T11:00:00Z",
  "dateModified": "2026-02-03T11:00:00Z",
  "additionalProperty": [
    {
      "@type": "PropertyValue",
      "propertyID": "app:bucket",
      "value": "reference"
    },
    {
      "@type": "PropertyValue",
      "propertyID": "app:origin",
      "value": "captured"
    }
  ]
}
```

### Calendar event (`Event`)

```json
{
  "@id": "urn:app:event:evt-001",
  "@type": "Event",
  "_schemaVersion": 2,
  "name": "Wochenbesprechung Team A",
  "startDate": "2026-03-01T09:00:00Z",
  "endDate": "2026-03-01T09:30:00Z",
  "duration": 30,
  "location": "Raum 42",
  "dateCreated": "2026-02-07T08:00:00Z",
  "dateModified": "2026-02-07T08:00:00Z",
  "additionalProperty": [
    {
      "@type": "PropertyValue",
      "propertyID": "app:bucket",
      "value": "calendar"
    },
    {
      "@type": "PropertyValue",
      "propertyID": "app:needsEnrichment",
      "value": false
    },
    {
      "@type": "PropertyValue",
      "propertyID": "app:confidence",
      "value": "high"
    }
  ]
}
```

> **Note:** `Event` uses `startDate`/`endDate` (schema.org Event properties), not `startTime`/`endTime`
> (which are schema.org Action properties). The frontend deserializes `Event` → `CalendarEntry`.
> Currently, the frontend creates calendar items as `Action` type; `Event` is an inbound-only type
> from the backend or external imports.

---

## Typed References (LexCEL Renvoi)

| Type           | Meaning                                 |
| -------------- | --------------------------------------- |
| `blocks`       | This item blocks another from starting  |
| `depends_on`   | Cannot start until dependency completes |
| `delegates_to` | Assigned to someone else                |
| `refers_to`    | General cross-reference                 |
| `context_of`   | Context tagging                         |
| `part_of`      | Sub-action of a project                 |
| `follows`      | Sequential ordering within a project    |
| `waiting_on`   | External dependency                     |

---

## Ports (LexCEL)

| Port              | Kind          | Purpose                                          |
| ----------------- | ------------- | ------------------------------------------------ |
| `DefinitionPort`  | `definition`  | What does "done" mean? (`doneCriteria`)          |
| `PredicatePort`   | `predicate`   | Conditions to start (`conditions[]`)             |
| `ComputationPort` | `computation` | Effort estimates (`timeEstimate`, `energyLevel`) |
| `ProcedurePort`   | `procedure`   | Checklist steps (`steps[]`)                      |

---

## Enrichable Interface (FRBR)

| Field             | Type                      | Description                      |
| ----------------- | ------------------------- | -------------------------------- |
| `needsEnrichment` | `boolean`                 | Flagged for review/clarification |
| `confidence`      | `high` / `medium` / `low` | How well-defined the item is     |

**Confidence lifecycle:**

| Stage      | `confidence` | `needsEnrichment` | Trigger                                        |
| ---------- | ------------ | ----------------- | ---------------------------------------------- |
| Capture    | `medium`     | `true`            | Heuristic classification at intake             |
| Triage     | `high`       | `false`           | User confirms type and assigns bucket          |
| Direct add | `high`       | `false`           | User creates action directly in a bucket       |
| Legacy     | `low`        | `true`            | Old items created before intake classification |

---

## Name vs rawCapture Semantics

`rawCapture` holds the user's original input text. `name` is an optional deliberate label,
only set when the user (or AI, with provenance) explicitly renames an item.

### Per-entity rules

| Entity type        | `name`                      | `rawCapture` |
| ------------------ | --------------------------- | ------------ |
| ActionItem (inbox) | optional — unset at capture | **required** |
| Action             | optional — unset at capture | **required** |
| Project            | **required**                | n/a          |
| ReferenceMaterial  | **required**                | n/a          |
| Context            | **required**                | n/a          |

File captures set `name` to the file name. URL captures do not set `name`.

### Display logic

```typescript
// frontend/src/model/types.ts
getDisplayName(item) → item.name ?? item.rawCapture ?? "Untitled"
```

### Lifecycle

1. **Capture**: user types "buy bananas" → `rawCapture = "buy bananas"`, `name` is unset
2. **Triage**: inbox → action — `rawCapture` preserved, `name` scopilots unset
3. **Rename**: user explicitly sets title → `name = "Weekly Groceries"`, `rawCapture` preserved
4. **Display**: `name` if set, otherwise `rawCapture`, otherwise `"Untitled"`

### JSON-LD serialization

- `name` is **omitted** from JSON-LD when unset (not set to `null`)
- `rawCapture` lives in `additionalProperty` as `app:rawCapture`
- On read (`fromJsonLd`): `null`, missing, `""`, and whitespace-only `name` all normalize to `undefined`

### Factory enforcement

`createThing()` requires at least one of `{name, rawCapture}`. Projects, references, and contexts require `name`.

---

## Provenance (No-Delete)

Every state change is recorded in `provenance.history`:

```typescript
interface ProvenanceEntry {
  timestamp: string; // ISO 8601
  action: ProvenanceAction;
  from?: string; // Previous state
  to?: string; // New state
  note?: string;
}
```

Actions: `created`, `clarified`, `moved`, `updated`, `archived`,
`enriched`, `completed`, `focused`, `unfocused`, `renamed`.

**No deletion** — only archiving via `provenance.archivedAt`.

---

## JSON Schema Contract

The machine-readable contract for JSON-LD payloads is **served by the backend API** at
`GET /schemas/{name}`. Schemas are generated at runtime from the Pydantic models in
`backend/app/models.py` — no static files to keep in sync.

The serializer contract tests in `item-serializer.test.ts` fetch these schemas, compile
AJV validators, and verify that every `build*` and `toJsonLd` output conforms. Tests skip
gracefully when the backend is unreachable.

| Schema name      | Pydantic model        | Purpose                                                |
| ---------------- | --------------------- | ------------------------------------------------------ |
| `inbox-item`     | `InboxItemJsonLd`     | Inbox capture payload (deprecated — use `action-item`) |
| `action-item`    | `ActionItemJsonLd`    | Action payload (inbox captures + triaged actions)      |
| `project-item`   | `ProjectItemJsonLd`   | Project payload                                        |
| `reference-item` | `ReferenceItemJsonLd` | Reference payload                                      |
| `event-item`     | `EventItemJsonLd`     | Event payload                                          |
| `item-patch`     | `ItemPatchModel`      | PATCH payload                                          |
| `property-value` | `PropertyValueModel`  | PropertyValue shape                                    |

See [Schema Contract Validation](?path=/docs/engineering-ontology-schema-contract-validation--docs)
for the full pipeline documentation, and
[Backend API Requests](?path=/docs/engineering-backend-api-requests-import-ux--docs) for endpoint docs.

---

## Known Deviations from schema.org Hierarchy

The app uses schema.org as its primary vocabulary but **intentionally deviates** from the
strict schema.org type hierarchy in several ways. These are documented here so consumers
of the JSON-LD data understand what is standard and what is app-specific.

### Correct schema.org usage

| Property                                | schema.org type | Notes                                  |
| --------------------------------------- | --------------- | -------------------------------------- |
| `name`, `description`, `url`            | Thing           | Available on all entities              |
| `startTime`, `endTime`                  | Action          | Correct temporal properties for Action |
| `encodingFormat`                        | CreativeWork    | MIME type for reference material       |
| `PropertyValue` (`propertyID`, `value`) | PropertyValue   | Standard extension point               |
| `DigitalDocument`                       | CreativeWork    | Subtype — correct for files            |
| `EmailMessage`                          | CreativeWork    | Subtype — correct for .eml/.msg        |

### Property domain extensions

| Property                      | Standard domain(s)                | Our usage           | Rationale                                                                                                                                                                                                                        |
| ----------------------------- | --------------------------------- | ------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `additionalProperty`          | Product, Place, Offer             | All entity types    | Universal extension mechanism for `app:*` properties. Schema.org validators are lenient about domain.                                                                                                                            |
| `keywords`                    | CreativeWork, Event, Organization | Thing, Action       | Tags apply to all entities, not just creative works. Widely used outside strict domain in practice.                                                                                                                              |
| `dateCreated`, `dateModified` | CreativeWork, DataFeedItem        | All entity types    | Timestamps are universal. These are the most natural schema.org properties for creation/modification tracking.                                                                                                                   |
| `app:projectRefs`             | n/a (custom)                      | Action → Project(s) | Many-to-many project membership via `additionalProperty`. Replaces the former `isPartOf`/`hasPart` bidirectional mapping which was semantically wrong (both properties have domain `CreativeWork`, not `Action`/`Organization`). |

### Type hierarchy deviations

| Deviation                         | schema.org says                                    | We do                                                       | Rationale                                                                                                                                                                                                      |
| --------------------------------- | -------------------------------------------------- | ----------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `Action` in inbox                 | `Action` implies an active item                    | `Action` with `bucket: "inbox"` and `needsEnrichment: true` | Text captures default to Action because the user expresses intent to do. The item sits in inbox until triaged. schema.org has no concept of "unprocessed" state.                                               |
| `DigitalDocument` as generic file | Subtype of `CreativeWork`                          | Used for any file drop (images, CSV, vCard, calendar)       | We don't distinguish `ImageObject` vs `DigitalDocument` at capture time. The MIME type is stored in `encodingFormat` for downstream specialization.                                                            |
| `Project` as pending type         | `Project` extends `Organization` (pending)         | Used as a top-level app type                                | `schema:Project` is a pending type not yet formally in the schema.org hierarchy. We use it because it directly expresses the concept. The Organization relationship is enforced at the API layer via `org_id`. |
| `CreativeWork` in inbox           | `CreativeWork` typically represents finished works | `CreativeWork` with `bucket: "inbox"` for URL captures      | A pasted URL is a reference to a creative work. It sits in inbox until triaged to `reference` bucket.                                                                                                          |

### Organization hierarchy

Every user gets a default **Organization** on registration (`"{username}'s Workspace"`).
All things (including projects) are scoped to an Organization via `org_id`.
Projects live within the user's Organization — the database enforces this relationship.
Users can belong to multiple Organizations (multi-tenancy ready).

---

## Future Work

### Layer 3 — Triage UI enhancements

- Show the heuristic `@type` prominently on inbox items (icon + label)
- "Change type" affordance — user can override the heuristic classification
- For files with `extractableEntities`: offer extraction actions in triage
  (e.g. "Extract contacts from this vCard?" → creates linked Person/Organization entities)
- Entity extraction creates linked entities via `refers_to` typed references
  while preserving the original file as a `DigitalDocument`

### Layer 4 — LLM-assisted classification

- Lightweight model to suggest `@type` for ambiguous text (e.g. "call Mueller" → Action vs. event?)
- Content-based file classification beyond MIME (e.g. extract title from PDF metadata)
- Confidence scoring: LLM-classified items could get `confidence: "medium"` vs heuristic `"medium"`,
  with a `classificationSource` field to distinguish

### Backend schema alignment

- Deprecate `inbox-item` schema — inbox items now use `action-item` (`@type: "Action"`)
- Add `DigitalDocument`, `EmailMessage` schema variants for file capture payloads
- Add `app:extractableEntities` to the backend `PropertyValue` allowlist

### Additional intake heuristics

- Detect text patterns for Events (dates, times, "meeting", "appointment")
- Detect multi-step outcomes for Project suggestions
- Support `text/x-vcard` MIME variant (already in MIME map, untested with real browsers)

---

## Type Guards

```typescript
isThing(item); // bucket in [inbox, next, waiting, calendar, someday]
isInboxItem(item); // item.bucket === "inbox"
isAction(item); // bucket in [next, waiting, calendar, someday]
isProject(item); // item.bucket === "project"
isReferenceMaterial(item); // item.bucket === "reference"
```

---

## Test Factories

**File**: `frontend/src/model/factories.ts`

```typescript
// Capture-first entities — rawCapture is primary, name is optional
createInboxItem({ rawCapture: "Anruf bei Frau Müller" });
// → bucket: "inbox", confidence: "medium", needsEnrichment: true

createThing({ rawCapture: "Deploy", bucket: "next", isFocused: true });
// → confidence: "high", needsEnrichment: false

createAction({ rawCapture: "Follow up", bucket: "waiting" });
// → bucket: "waiting", confidence: "high", needsEnrichment: false

// Non-capture entities — name is required
createProject({ name: "Relaunch", desiredOutcome: "Site live" });
createReferenceMaterial({ name: "SGB III § 159" });
createContext({ name: "@computer" });
createTypedReference({ type: "blocks", targetId });
definitionPort("Wireframes approved");
procedurePort([{ text: "Header" }, { text: "Footer" }]);
```
