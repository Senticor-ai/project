import { Meta } from "@storybook/addon-docs/blocks";

<Meta title="Product/Epics/Swipe Triage and Touch Gestures" />

# Epic: Swipe Triage & Touch Gestures

**Status:** Draft
**Priority:** Current
**Last updated:** 2026-02-26
**Depends on:** Existing inline triage flow, `ActionRow` expand/collapse, toast system
**Related:** [Collect to Engage](?path=/docs/flows-collect-to-engage--docs), [Paperclip Principles](?path=/docs/design-paperclip-principles--docs)

---

## Context

Senticor's GTD workflow has a solid state model (Inbox → Next → Waiting → Calendar → Someday →
Focus → Archive) and desktop triage works well: expand an inbox item, click a bucket button, move on.

On mobile, however, the experience is slow and friction-heavy:

1. **No touch-native triage.** Users must tap to expand each inbox item, then tap a small bucket
   button. On a phone this means 2–3 precise taps per item instead of the fluid, kinetic
   interaction mobile users expect.

2. **Drag-and-drop is disabled on mobile.** `BucketView.tsx` (line 170) sets
   `sensors={isMobile ? [] : undefined}`, leaving mobile users with zero gestural interaction.

3. **No rapid sequential triage.** The inbox auto-expands the first item (`effectiveExpandedId`
   in `ActionList.tsx`), but after triaging it the user must wait for the next item to expand.
   There is no card-deck metaphor for flowing through items at speed.

4. **Batch operations require desktop patterns.** The existing `selectedIds` set in
   `ActionList.tsx` uses Ctrl/Cmd+Click and Shift+Click — desktop-only patterns with no
   touch equivalent.

### Competitive gap

Todoist, Things 3, and Tody all offer swipe-based triage that feels kinetic and immediate.
The Paperclip Principle **"Speed Over Ceremony"** demands the same.

---

## User Story

> "Ich will meinen Posteingang auf dem Handy durcharbeiten, indem ich Einträge nach rechts
> wische für ‚Nächste Schritte' und nach links für ‚Warten'. Wenn ich mich verwische,
> möchte ich es sofort rückgängig machen können."

---

## Goals

1. **Touch-native inbox triage** — swipe gestures as first-class interaction for moving items.
2. **Visual feedback during gestures** — color-coded indicators showing the target bucket
   before commit.
3. **Quick Triage Mode** — sequential card-by-card flow for processing inbox like a card deck.
4. **Long-press multi-select** — touch-native batch selection.
5. **Undo safety net** — toast with undo for every swipe move (Paperclip Principle:
   "Reversibility Is Sacred").
6. **Zero new dependencies** — use `framer-motion` (already installed) for drag gestures.

---

## Out of Scope

- Swipe gestures on non-inbox buckets (post-MVP extension)
- Custom gesture mapping UI (MVP uses fixed left/right assignments)
- Haptic feedback via Web Vibration API
- 3D touch / force-touch interactions
- Desktop swipe via trackpad gestures (mouse users have drag-and-drop)

---

## MVP Scope

### 1) Swipe gestures on inbox items

Each `ActionRow` in the inbox gains a horizontal swipe gesture when `useIsMobile()` returns `true`.

| Direction       | Default target | Color                          | Icon       |
| --------------- | -------------- | ------------------------------ | ---------- |
| Swipe right (→) | `next`         | `--color-app-next` (green)     | `bolt`     |
| Swipe left (←)  | `waiting`      | `--color-app-waiting` (purple) | `schedule` |

**Gesture thresholds:**

- **Activation distance:** 8px horizontal before gesture is recognized
- **Commit threshold:** 40% of row width (~130px on 375px viewport)
- **Velocity shortcut:** > 800px/s commits regardless of distance (fast flick)
- **Vertical lock:** If `|deltaY| > |deltaX|` in first 12px → cancel gesture, allow native scroll
- **Elastic resistance:** Beyond commit threshold, apply `x * 0.3` damping

Implementation: `framer-motion`'s `motion.div` with `drag="x"`, `dragDirectionLock`, reading
`panInfo.offset.x` and `panInfo.velocity.x` in `onDragEnd`.

### 2) Visual feedback during swipe

As the user drags an inbox row, the background reveals a color-coded indicator:

**Right swipe (→ Next):**

- Background: `bg-app-next/15` (green tint, 15% opacity)
- Icon: `bolt` in `text-app-next`, scales from 0.8 → 1.0 as threshold approaches
- Label: "Nächste Schritte" fades in at 20% threshold

**Left swipe (← Waiting):**

- Background: `bg-app-waiting/15` (purple tint)
- Icon: `schedule` in `text-app-waiting`
- Label: "Warten auf" fades in at 20% threshold

**Commit indicator (at 40% threshold):**

- Background opacity jumps from 15% to 30%
- Icon scales to 1.2 with snap transition
- Subtle border: `border-app-next/30` or `border-app-waiting/30`

**Cancel / snap-back:**

- Released before threshold → spring back to x=0 (`stiffness: 500, damping: 30`)
- Background indicator fades out over 150ms

### 3) Long-press → multi-select mode

**Activation:**

- Long-press (500ms) on any inbox item enters multi-select mode
- Item is immediately selected (existing `isSelected` styling: `bg-blueprint-50 ring-1 ring-blueprint-200`)
- Subsequent taps toggle selection (no long-press required once in mode)

**Batch action bar:**

- Reuse existing batch toolbar from `ActionList.tsx` (lines 547–668)
- On mobile: slides up from bottom (fixed position) instead of inline
- Same bucket buttons: Next, Waiting, Calendar, Later, Reference, Archive
- "Alle auswählen" / "Auswahl aufheben" controls

**Exit multi-select:**

- Tap "Auswahl aufheben" or tap outside any item
- Swipe gestures disabled while multi-select is active

### 4) Quick Triage Mode (card deck)

**Entry point:**

- Button in inbox header: "Schnell-Triage" with icon `style`
- Only visible on mobile when inbox has ≥ 2 items

**Card deck UI:**

- Full-width card showing one inbox item at a time
- Card displays: title, source indicator, description preview (3 lines max), tags, project badge
- Stack preview: 2 cards behind active card (offset 4px/8px down, reduced opacity 0.7/0.4)
- Card is a `motion.div` with same swipe thresholds as list mode

**Triage actions:**

1. **Swipe right →** Move to Next
2. **Swipe left ←** Move to Waiting
3. **Tap card →** Expand to show full triage bottom sheet with all bucket buttons

**Card transition animation:**

- On commit: card flies out in swipe direction (`x: ±100vw`, `opacity: 0`, `rotate: ±8deg`)
- Duration: 250ms, easing: `--ease-snap`
- Next card slides up from stack position

**Completion:**

- All cards triaged → "Posteingang leer — gut gemacht!" with checkmark animation
- Auto-return to inbox list view after 1.5s

### 5) Undo toast for accidental swipes

Every swipe-triggered move fires a toast with undo action.

- Message: `"'{itemName}' → Nächste Schritte"` or `"'{itemName}' → Warten auf"`
- Action: `{ label: "Rückgängig", onClick: () => onMove(id, "inbox") }`
- Auto-dismiss: 5 seconds
- Multiple rapid swipes produce stacked toasts (existing `AnimatePresence` supports this)

### 6) Gesture configuration (stored, not UI-exposed)

Store swipe mappings in localStorage:

```json
{ "swipeRight": "next", "swipeLeft": "waiting" }
```

MVP reads this config but does not expose a settings UI. Future epic adds custom mapping.

---

## Product Behavior

### Gesture vs. scroll disambiguation

1. On `touchstart`, record initial coordinates
2. First `touchmove` exceeding 12px total:
   - `|deltaY| > |deltaX|` → vertical scroll, release gesture
   - `|deltaX| > |deltaY|` → horizontal swipe, prevent scroll, begin gesture
3. Direction locked until `touchend`

Implemented via `framer-motion`'s `dragDirectionLock`.

### Interaction with existing expand/collapse

- **Tap** → toggles expand/collapse (existing `onToggleExpand`)
- **Horizontal drag** → initiates swipe gesture
- **Vertical drag** → scrolls the list
- Mutually exclusive once direction is locked

### Interaction with @dnd-kit

- Swipe gestures: mobile only (`useIsMobile() === true`)
- `@dnd-kit` drag-and-drop: desktop only (existing `sensors={isMobile ? [] : undefined}`)
- No conflict — the two systems operate on different viewport sizes

### iOS Safari edge swipe

Set activation zone to exclude leftmost 20px of viewport to avoid conflict with
browser back gesture.

### Accessibility

- Swipe gestures are progressive enhancement — all triage actions remain available via buttons
- Screen reader users use expand → button triage path
- Quick Triage Mode cards include `aria-label` with item title and actions
- `role="group"` on card stack with `aria-roledescription="Schnell-Triage Kartenstapel"`
- Announce results via `aria-live="polite"` region

### Bottom sheet for card tap

When user taps a card in Quick Triage Mode, full options appear as a bottom sheet
(shadcn `Sheet` with `side="bottom"`):

| Button | Label            | Bucket      | Icon             |
| ------ | ---------------- | ----------- | ---------------- |
| 1      | Nächste Schritte | `next`      | `bolt`           |
| 2      | Warten auf       | `waiting`   | `schedule`       |
| 3      | Kalender         | `calendar`  | `calendar_month` |
| 4      | Irgendwann       | `someday`   | `cloud`          |
| 5      | Referenz         | `reference` | `description`    |
| 6      | Archivieren      | (archive)   | `archive`        |

"Weitere Optionen" expander below for project/date/context (reuses `ItemEditor`).

---

## Acceptance Criteria

- [ ] Swiping an inbox item right moves it to the configured right-swipe bucket (default: Next)
- [ ] Swiping an inbox item left moves it to the configured left-swipe bucket (default: Waiting)
- [ ] Swipe shows color-coded background indicator matching target bucket color
- [ ] Releasing before 40% commit threshold snaps the row back with spring animation
- [ ] Fast flick (> 800px/s) commits the swipe regardless of distance
- [ ] Vertical scrolling is not disrupted by swipe gesture detection
- [ ] Undo toast with "Rückgängig" action appears after every swipe move
- [ ] Tapping "Rückgängig" returns the item to inbox
- [ ] Long-press (500ms) enters multi-select mode
- [ ] In multi-select mode, tapping items toggles selection, batch toolbar appears
- [ ] Swipe gestures disabled during multi-select
- [ ] Quick Triage Mode shows card deck for sequential inbox processing
- [ ] Swiping a card flies it out and advances to next card
- [ ] Tapping a card shows full triage bottom sheet
- [ ] "Posteingang leer" celebration shown when all items processed
- [ ] Swipe gestures only active on mobile (`useIsMobile() === true`)
- [ ] Desktop drag-and-drop continues unchanged
- [ ] All button-based triage actions remain functional (progressive enhancement)
- [ ] Screen reader triage via expand → button flow works

---

## Delivery Plan

### Phase 1: SwipeableRow foundation

- Create `SwipeableRow.tsx` with `framer-motion` drag gestures
- Implement direction lock (horizontal vs vertical disambiguation)
- Implement commit threshold (40% width OR 800px/s velocity)
- Implement background indicator layer with icons and labels
- Implement spring snap-back on cancel
- Unit tests for threshold calculations and direction lock
- Storybook story: `SwipeableRow.stories.tsx` with interactive demo

### Phase 2: Inbox swipe integration + undo

- Integrate `SwipeableRow` into `ActionList.tsx` for mobile inbox items
- Wire `onSwipeRight` / `onSwipeLeft` to `onMove` with configured buckets
- Implement undo toast using existing `useToast()`
- Create `useSwipeTriageConfig` hook (localStorage persistence)
- Integration test: `swipe-triage-mocked.spec.ts`

### Phase 3: Long-press multi-select

- Implement long-press detection (500ms timeout, movement cancellation)
- Enter multi-select mode, reuse existing `selectedIds` state
- Mobile-optimized batch toolbar (fixed bottom position)
- Disable swipe when multi-select active

### Phase 4: Quick Triage Mode

- Create `QuickTriageView.tsx` with card deck layout
- Card stack visual (active + 2 preview cards)
- Wire swipe gestures on active card
- Tap → bottom sheet with full triage options
- Card fly-out and advance animation
- Empty-inbox celebration state
- Storybook story: `QuickTriageView.stories.tsx`

### Phase 5: Polish and accessibility

- ARIA labels and live regions
- iOS Safari edge swipe avoidance (20px exclusion zone)
- Performance: ensure 60fps during swipe animations
- Update `CollectToEngage.mdx` with swipe triage path
- `npm run preflight:local` — all checks green

---

## Animation Specifications

| Animation            | Property                             | Duration                 | Easing          |
| -------------------- | ------------------------------------ | ------------------------ | --------------- |
| Indicator fade-in    | opacity: 0 → 0.15 → 0.30             | Continuous (from drag x) | Linear          |
| Indicator icon scale | scale: 0.8 → 1.0 → 1.2               | Continuous               | Linear          |
| Swipe commit fly-out | x: ±100vw, opacity: 0, rotate: ±8deg | 250ms                    | `--ease-snap`   |
| Cancel snap-back     | x: current → 0                       | Spring (500/30)          | Spring          |
| Card deck next-up    | y: 4px → 0, opacity: 0.7 → 1.0       | 200ms                    | `--ease-snap`   |
| Completion checkmark | scale: 0 → 1, opacity: 0 → 1         | 300ms                    | `--ease-unfold` |
| Multi-select toolbar | y: 100% → 0                          | 200ms                    | `--ease-unfold` |
| Long-press feedback  | scale: 1.0 → 0.97 → 1.0              | 150ms                    | `--ease-snap`   |

---

## Risks and Mitigations

| Risk                                         | Mitigation                                                                            |
| -------------------------------------------- | ------------------------------------------------------------------------------------- |
| Swipe conflicts with iOS Safari back gesture | Exclude leftmost 20px from activation zone                                            |
| `framer-motion` drag perf on low-end Android | Use `useMotionValue` + `useTransform` (no re-renders); test on Moto G Power           |
| Accidental swipes during scroll              | Direction lock with 12px dead zone                                                    |
| Undo toast dismissed before noticed          | 5s auto-dismiss with prominent "Rückgängig" button; manual move-back always available |
| Two triage interfaces confuse users          | Quick Triage is opt-in via explicit button; list mode remains default                 |

---

## Key Files

| File                                               | Change                                                                   |
| -------------------------------------------------- | ------------------------------------------------------------------------ |
| `frontend/src/components/work/SwipeableRow.tsx`    | New — gesture wrapper with indicators                                    |
| `frontend/src/components/work/QuickTriageView.tsx` | New — card deck triage mode                                              |
| `frontend/src/components/work/TriageCard.tsx`      | New — single card for deck mode                                          |
| `frontend/src/hooks/use-swipe-triage-config.ts`    | New — localStorage config                                                |
| `frontend/src/hooks/use-long-press.ts`             | New — reusable long-press hook                                           |
| `frontend/src/components/work/ActionList.tsx`      | Wrap inbox rows with `SwipeableRow`, add Quick Triage toggle, long-press |
| `frontend/src/docs/flows/CollectToEngage.mdx`      | Add swipe triage to Phase 2 flow                                         |

---

## Definition of Done

- [ ] All acceptance criteria pass on iPhone Safari and Android Chrome
- [ ] 60fps maintained during swipe animations
- [ ] VoiceOver and TalkBack can navigate and triage without gestures
- [ ] Desktop drag-and-drop tests continue to pass
- [ ] `npm run preflight:local` passes
- [ ] Storybook stories render in mobile and desktop viewports
- [ ] Playwright integration tests pass in CI
