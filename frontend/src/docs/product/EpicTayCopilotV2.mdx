import { Meta } from "@storybook/addon-docs/blocks";

<Meta title="Product/Epics/Copilot V2+" />

# Epic: Copilot V2+ — Multi-turn, Streaming & Infrastructure

**Status:** In progress
**Priority:** Current
**Depends on:** [Copilot V1](?path=/docs/product-epics-copilot-v1--docs)
**See also:** [Schema Enrichment](?path=/docs/product-epics-schema-org-type-enrichment--docs) (richer item types for Copilot suggestions)

## Context

V1 delivered a single-message chat flow: user message → FastAPI proxy → Haystack agent → OpenRouter → tool calls → response. Three tools, German system prompt, graceful 503/502 handling.

This epic collects everything deferred from V1 that makes Copilot a production-grade conversational assistant. Most items have now been implemented.

---

## Work Items

### 1. Conversation History / Multi-turn Context ✅

Server-side conversation history so Copilot can reference prior messages, follow up on suggestions, and maintain coherent multi-turn dialogue.

- [x] Store conversation turns in the DB (`conversations` + `chat_messages` tables)
- [x] Fetch and include last 50 messages in each completion request (`get_conversation_messages`)
- [x] Frontend `conversationId` per session, sent with each request
- [x] Clear/reset conversation action in UI (`startNewConversation` in `useChatState`)
- [ ] Context window budget management (token counting, summarization) → deferred to V3

### 2. User Items in Prompt Context ✅

Copilot can see what the user already has via inline read tools.

- [x] `list_workspace_overview` — projects and item counts per bucket
- [x] `read_item_content` — fetch item data + extracted file text
- [x] `list_project_items` — list all items in a project
- [x] Privacy boundary: delegated JWT scoped to current user's org
- [ ] RAG/embedding strategy for large workspaces → deferred to V3

### 3. Streaming (NDJSON) ✅

Tokens stream as they arrive for a responsive feel.

- [x] Backend: NDJSON streaming from agents service
- [x] Frontend: `readNdjsonStream` parser in `useTayApi`
- [x] Incremental rendering in `TayMessageBubble` with `isStreaming` flag
- [x] Tool call events (`tool_calls`, `auto_executed`) during stream
- [x] Done event finalizes message

### 4. Model Fallback ✅

Supports comma-separated model list in `AGENT_MODEL` with retry on failure.

- [x] Parse model list from env var
- [x] Retry logic across models in `run_agent()` / `run_agent_streaming()`
- [x] Log which model ultimately served each request
- [x] OpenTelemetry span attributes for model info

### 5. K8s Deployment Manifest for Agents ✅

Agents workload separated for independent scaling.

- [x] `agents/Dockerfile` — Python 3.12 + uv, uvicorn on port 8002
- [x] `infra/k8s/base/agents.yaml` — Deployment + Service with health probes
- [x] Production patch with resource limits (100m/256Mi → 500m/1Gi)
- [x] CI `push-agents` job builds and pushes Docker image
- [x] `update-manifests` job includes agents image tag

### 6. CI Pipeline Jobs for Agents ✅

CI stages that validate agent-related code.

- [x] `agents-lint` — `ruff check .`
- [x] `agents-typecheck` — `mypy .`
- [x] `agents-unit` — `pytest tests/`
- [x] All push jobs depend on agents CI passing

### 7. DB Persistence for Conversations ✅

Conversations persisted in PostgreSQL so users can resume or review past chats.

- [x] `conversations` table: `id`, `org_id`, `user_id`, `external_id`, `agent_backend`, `title`, `created_at`, `updated_at`, `archived_at`
- [x] `chat_messages` table: `id`, `conversation_id`, `role`, `content`, `tool_calls`, `created_at`
- [x] Backend API: `GET /chat/conversations`, `GET /chat/conversations/:id/messages`, `PATCH /chat/conversations/:id/archive`
- [x] Frontend: conversation list with resume, archive, and new conversation actions
- [x] `ConversationList` component with history toggle in `TayChatPanel` header

---

## Dependencies & Sequencing

| Item                 | Depends on         | Status    |
| -------------------- | ------------------ | --------- |
| Multi-turn context   | DB persistence     | ✅ Done   |
| User items in prompt | Multi-turn context | ✅ Done   |
| Streaming            | Independent        | ✅ Done   |
| Model fallback       | Independent        | ✅ Done   |
| K8s manifest         | Independent        | ✅ Done   |
| CI pipeline          | K8s manifest       | ✅ Done   |
| DB persistence       | Independent        | ✅ Done   |

---

## What's done

### Infrastructure

- [x] `agents/Dockerfile` — containerized agents service
- [x] `infra/k8s/base/agents.yaml` — K8s Deployment + Service
- [x] `infra/k8s/overlays/production/patches/agents.yaml` — production resource limits
- [x] CI: `push-agents` job + `update-manifests` includes agents image

### Backend

- [x] `POST /chat/completions` — NDJSON streaming with conversation history
- [x] `POST /chat/execute-tool` — tool execution proxy
- [x] `GET /chat/conversations` — list active conversations
- [x] `GET /chat/conversations/:id/messages` — get conversation messages
- [x] `PATCH /chat/conversations/:id/archive` — soft-delete conversation
- [x] `queries.py`: `list_conversations`, `archive_conversation`, `get_or_create_conversation`, `save_message`, `get_conversation_messages`

### Agents

- [x] Streaming with `run_agent_streaming()` yielding NDJSON events
- [x] Model fallback with comma-separated `AGENT_MODEL`
- [x] Read tools: `list_workspace_overview`, `read_item_content`, `list_project_items`
- [x] Delegated JWT auth for backend API calls

### Frontend

- [x] Types: `ConversationSummary`, `ConversationMessageResponse` in `chat-types.ts`
- [x] API: `ChatApi.listConversations()`, `.getConversationMessages()`, `.archiveConversation()`
- [x] Hook: `useChatState` with `startNewConversation()` and `loadConversation()`
- [x] Component: `ConversationList` (list, resume, archive, new conversation)
- [x] Component: `TayChatPanel` with history toggle button
- [x] MSW: conversation management handlers
- [x] Tests: `ConversationList.test.tsx`, updated `TayChatPanel.test.tsx`
- [x] Stories: `ConversationList.stories.tsx`

---

## Deferred to V3

- Context window budget management (token counting, summarization)
- RAG/embedding strategy for large item sets
- Conversation title generation (auto-summarize first message)
- Conversation search

---

## Acceptance criteria

- [x] Conversation history is persisted and each new completion request includes recent conversation turns for the active conversation.
- [x] Prompt context injection includes only current-user items via delegated JWT and read tools.
- [x] Streaming endpoint emits incremental assistant content and the frontend renders partial tokens without waiting for full completion.
- [x] Tool calls remain valid under streaming mode (partial tool JSON is assembled and executed only after valid completion).
- [x] Model fallback retries across configured models with bounded backoff and records the final serving model in telemetry.
- [x] Agents deployment manifests include health probes, resource limits, and network policy for API/OpenRouter paths.
- [x] CI includes agent lint, type-check, unit tests, and integration tool-call verification.
- [x] Conversation persistence APIs support list, fetch messages, append message, and archive flows.

---

## Definition of Done

- [x] All acceptance criteria above are covered by automated tests or reproducible manual verification steps.
- [x] Backend endpoints for streaming and conversations have passing test coverage (unit + integration).
- [x] Frontend chat UI has passing tests for multi-turn, streaming, and resume/archive behavior.
- [x] Agent reliability behaviors (fallback, telemetry attributes, retry limits) are observable in logs/traces.
- [x] Deployment + CI updates are merged and validated in non-local environments.
- [x] Documentation for sequence/dependencies stays aligned with shipped scope.

---

## Files

### Infrastructure (new)

| File | Purpose |
| ---- | ------- |
| `agents/Dockerfile` | Agents service container image |
| `infra/k8s/base/agents.yaml` | K8s Deployment + Service |
| `infra/k8s/overlays/production/patches/agents.yaml` | Production resource limits |

### Backend (modified)

| File | Change |
| ---- | ------ |
| `backend/app/chat/queries.py` | Added `list_conversations`, `archive_conversation` |
| `backend/app/chat/routes.py` | Added `GET /conversations`, `GET /:id/messages`, `PATCH /:id/archive` |
| `backend/tests/test_chat_routes.py` | Tests for conversation management endpoints |

### Frontend (new)

| File | Purpose |
| ---- | ------- |
| `src/components/chat/ConversationList.tsx` | Conversation list with resume/archive |
| `src/components/chat/ConversationList.test.tsx` | Unit tests |
| `src/components/chat/ConversationList.stories.tsx` | Storybook stories |

### Frontend (modified)

| File | Change |
| ---- | ------ |
| `src/model/chat-types.ts` | Added `ConversationSummary`, `ConversationMessageResponse` |
| `src/hooks/use-tay-api.ts` | Added `ChatApi` with conversation management methods |
| `src/hooks/use-chat-state.ts` | Added `startNewConversation`, `loadConversation` |
| `src/components/chat/TayChatPanel.tsx` | Added history toggle + conversation list integration |
| `src/App.tsx` | Pass `onNewConversation`, `onLoadConversation` to panel |
| `src/test/msw/handlers.ts` | Conversation management MSW handlers |
| `src/test/msw/fixtures.ts` | Added `conversations` store |

### CI (modified)

| File | Change |
| ---- | ------ |
| `.github/workflows/ci.yml` | Added `push-agents` job, updated `update-manifests` |
| `infra/k8s/base/kustomization.yaml` | Added `agents.yaml` resource |
| `infra/k8s/overlays/production/kustomization.yaml` | Added agents image + patch |

---

## Verification

```bash
# Backend
cd backend && uv run ruff check .
cd backend && uv run mypy app/
cd backend && uv run python -m pytest

# Agents
cd agents && uv run ruff check .
cd agents && uv run mypy .
cd agents && uv run python -m pytest tests/

# Frontend
cd frontend && npx tsc -b --noEmit
cd frontend && CI=1 npx vitest run --project=unit
cd frontend && npx storybook build
```
