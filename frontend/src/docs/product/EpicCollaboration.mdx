import { Meta } from "@storybook/addon-docs/blocks";

<Meta title="Product/Epics/Collaboration Workspace" />

# Epic: Collaboration Workspace (Shared Projects + Kanban)

**Status:** In progress (backend architecture + API integration tests complete)
**Last updated:** 2026-02-23
**Priority:** Current
**Design direction:** Board-first team workflow

## Context

Senticor Project is strong for personal task execution, but the current project experience is
mostly single-user and list-oriented. To support real joint execution, users need to share a
project with teammates, collaborate on the same work items, and track progress visually.

**Problem:** Two people working on the same initiative cannot reliably coordinate in one shared
project with a clear flow from intake to completion.

**Outcome:** A shared project workspace where registered users can collaborate in either list or
kanban mode, manage action cards together, and track delivery state with a standards-based status model.
The product model remains schema.org-aligned and portable to graph/triple-store representation later.

---

## User Story

> "I want to share a project with my colleague, switch to a board view when planning execution,
> and move tasks through clear steps so we can manage joint work in one place."

---

## MVP Scope

### 1) Shared project access (registered users only)

- Project owner can add collaborators by email from project settings.
- Invite target must already be a registered user in the system.
- If user is not registered, sharing is blocked with a clear message to register first.
- Owner can remove collaborators.
- Collaborators can view and edit project content.

### 1a) Inline project settings (project title -> more options)

- Project settings are inline in the project workspace, not a separate screen for MVP.
- Clicking the project name opens an inline "More options" section (same interaction style as item edit).
- Inline settings include:
  - add/remove collaborators
  - project due date
- Owner can edit all settings; members can view settings and edit only allowed fields.

### 2) List to Kanban view toggle per project

- A project can be viewed in either list mode (existing behavior) or kanban mode.
- Toggle is available in project workspace header.
- Preference persists per project and user.
- Both views operate on the same underlying items (no duplicate data models).

### 2a) Deep links for project views

- Project list and board views are addressable via stable URL state.
- Opening a deep link restores:
  - selected project
  - selected view mode (`list` or `kanban`)
  - active filters where present (for example tag filter)
- Users can copy/paste URL links to share direct entry points with collaborators.

### 3) Action-only board cards

- Every card shown in kanban is a schema.org `Action`.
- Card UI supports quick inline edits for frequent fields (title, status, due date, assignee/collaborator, tags).
- Quick-add supports minimal required fields; simple edits happen directly on the card.
- Event and asset context is attached to actions through references (for example links to `Event` items or `DigitalDocument`/`CreativeWork` items).
- Double-clicking a card opens an advanced edit panel for complex edits.
- Advanced panel supports full description editing with markdown source + rendered preview (WYSIWYG-like editing flow for MVP).

### 3a) Shared project visual indicator

- Shared projects are visually marked in project lists and headers with a collaboration icon/badge.
- Indicator is visible in both list and kanban views.
- Tooltip/label clarifies that the project has multiple collaborators.

### 3b) Assignee model (owner of action)

- Quick edit supports assigning an action owner.
- Owner picker source priority:
  - users in the system directory
  - contacts from the user's contact list (if available)
  - free-text fallback (for external people, for example email/name not registered in system)
- Data model supports both structured owner reference and free-text owner.

### 3c) Due date UX

- Due date is quick-set directly on cards.
- Visual urgency indicators are visible in board and list:
  - due today
  - overdue
- Sorting/filtering can prioritize urgent cards.

### 3d) Tagging and filtering

- Actions support freeform tags in quick edit.
- Board and list views support filtering by tag.
- Active filters are visible and easy to clear.

### 3e) Comments and revision history

- Any project member can add comments on an action.
- Threaded comments are supported.
- Board cards show a compact comment indicator/count when comments exist.
- Action edits maintain revision history (what changed, who changed it, when).

### 4) Default action statuses (MVP)

Kanban columns map to schema.org `actionStatus` enum values:

1. `Backlog` -> `PotentialActionStatus`
2. `In Progress` -> `ActiveActionStatus`
3. `Done` -> `CompletedActionStatus`
4. `Blocked` -> `FailedActionStatus`

Cards can be moved between statuses via drag-and-drop and keyboard-accessible move actions.

Additional statuses and custom stage labels are out of MVP scope.

### 4a) Dynamic-ready workflow architecture (no custom UI yet)

- Store workflow policy as a project-level definition object, not hardcoded board columns.
- Workflow definition contains:
  - `canonicalStatuses`: the 4 supported `actionStatus` enum values
  - `transitions`: allowed status-to-status edges
  - `defaultStatus`, `doneStatuses`, `blockedStatuses`
  - `columnLabels`: display labels (`Backlog`, `In Progress`, `Done`, `Blocked`)
  - `policyMode`: `open` (MVP) or `restricted` (future)
- Each board card persists schema.org `actionStatus` as canonical status.
- Board columns render from workflow definition (`columnLabels` + mapped `canonicalStatuses`).
- Transition validation always goes through one backend policy function:
  - MVP: `policyMode = "open"` (allow transitions between the 4 default statuses)
  - Future: `policyMode = "restricted"` (enforce transition graph + rules)
- Future customization path:
  - add optional custom stage definitions that map to a canonical `actionStatus`
  - keep `actionStatus` stable for interoperability and reporting

---

## Interaction Model (MVP)

Borrow the following proven patterns:

- Board-first planning with columns as explicit stages
- Quick card creation inside each column
- Drag-and-drop card movement between columns
- Lightweight card details panel for metadata edits

Do not include in MVP:

- Power-ups/automation rules
- Custom column definitions
- External guest invites
- Advanced reporting dashboards

---

## Product Behavior

### Permissions

- `Owner`: manage collaborators, edit all project items, move cards across board states.
- `Member`: edit project items, move cards across board states.
- Non-members cannot access the project.
- Collaboration membership semantics align to schema.org `member` on `Project` (implemented via
  relational membership records in MVP).

### State model

- Board items are `Action` entities only.
- Canonical state field is schema.org `actionStatus`.
- Allowed MVP values:
  - `PotentialActionStatus` (Backlog)
  - `ActiveActionStatus` (In Progress)
  - `CompletedActionStatus` (Done)
  - `FailedActionStatus` (Blocked)
- Source-of-truth for movement is immutable transition events; current `actionStatus` is a
  rebuildable projection for reads.
- Existing list and kanban views derive grouping/sorting from projected `actionStatus`.
- `Event` and `DigitalDocument`/`CreativeWork` items are linked context for actions, not standalone board cards in MVP.

### Project settings UX

- Clicking the project name expands inline settings in context.
- Settings include collaborators and project due date.
- Changes save in place and apply to both list and kanban views.

### Routing and shareability

- URL/query state carries project + view mode so board/list are deep-linkable.
- Opening deep links restores view context and relevant filters.

### Collaboration affordances

- Shared projects show a visible collaboration marker in project chrome.
- Actions expose assignee and comment indicators directly on cards.
- Threaded discussion semantics align with schema.org `Comment` and parent-child comment
  relationships.

### Card edit modes

- Single-click/expanded card: quick inline editing for common fields.
- Double-click: open advanced edit panel for deep edits (full description markdown editing, references, and metadata).

### Multi-user consistency

- Changes by one member are visible to other members on refresh.
- Activity metadata records `updatedBy` and timestamp for auditability.
- Comment and revision history preserve actor and timestamp metadata.

---

## Acceptance Criteria

- [x] Project owner can add an existing registered user to a project by email.
- [x] Sharing with an unregistered email is rejected with actionable feedback.
- [ ] Project header shows a working list/kanban toggle.
- [ ] Project list/board URLs are deep-linkable and restore project + view mode on load.
- [ ] Clicking project name opens inline settings with collaborator management and due date.
- [ ] Shared projects show a visible collaboration icon/badge.
- [ ] Kanban board shows 4 default columns mapped to `actionStatus`: Backlog, In Progress, Done, Blocked.
- [ ] Users can create `Action` cards from board UI.
- [ ] Action cards can attach/link event and asset context (for example Event and DigitalDocument references).
- [ ] Action owner can be set quickly from directory/contacts or free-text fallback.
- [ ] Due date can be set quickly on cards and clearly indicates today/overdue states.
- [ ] Freeform tags can be added quickly and filtered in list/kanban.
- [ ] Cards show comment indicator/count; threaded comments are accessible from card/detail.
- [x] Action edits are revisioned with actor + timestamp.
- [ ] Card quick-edit works inline and double-click opens advanced edit panel.
- [ ] Cards can move between columns and persist after page reload.
- [ ] Board and list views stay consistent via shared `actionStatus` source.
- [x] Both owner and member can collaborate on the same project without permission leakage.
- [ ] Collaboration commands are available via `senticor-copilot` and `@project/core` SDK wrappers.
- [ ] Copilot can complete the collaboration workflow using only `copilot_cli` (`argv[]`, `--json`, non-interactive).

---

## Delivery Plan

### Phase 1: Sharing foundations

- [x] Project member table + API + permission checks
- [ ] Inline project settings UI (project-name click to open settings section)
- [x] Collaborator add/remove APIs
- [ ] Project due date in inline project settings
- [ ] Shared project visual marker in project list/header
- [ ] Deep-link routing for project list/kanban views
- [x] Registered-user lookup and validation messaging

### Phase 2: Kanban read/write

- [ ] Project view toggle (list/kanban)
- [x] Workflow definition endpoint + item queries by projected `actionStatus`
- [ ] Board columns rendered in UI from workflow definition
- [ ] Drag-and-drop plus keyboard move affordance
- [x] Backend transition validator with policy mode (`open` now, `restricted` later)
- [x] Append-only transition event writes + state projection updater
- [x] Assignee backend model/API (`owner_user_id` + `owner_text` fallback)
- [ ] Assignee quick edit UX (directory + contact + free-text flow)
- [x] Due date backend/API support
- [ ] Due date quick-set UX + visual urgency indicators
- [x] Tag backend/API support + filtering params
- [ ] Tag quick edit + filtering UX in board/list

### Phase 3: Card creation + polish

- [x] Action create API (`POST /projects/{project_id}/actions`)
- [ ] Quick-add for `Action` in board UI
- [x] Action update API (`PATCH /projects/{project_id}/actions/{action_id}`)
- [ ] Inline card quick-edit behaviors
- [ ] Advanced edit panel on double-click with full markdown description editing
- [x] Event/asset link field support in action API (`object_ref`)
- [ ] Event/asset linking UX inside action detail
- [x] Threaded comments API (`POST /comments` with `parent_comment_id`)
- [ ] Threaded comments with card-level indicator
- [x] Revision history + transition history APIs
- [ ] Revision history timeline in advanced action view
- [ ] Empty states and onboarding hints

### Phase 4: CLI/SDK + Copilot collaboration flows

- [ ] Add collaboration command group(s) to CLI (`projects members`, `projects actions`, `projects workflow`)
- [ ] Add matching `@project/core` SDK methods with typed request/response envelopes
- [ ] Ensure write commands return projection + last-event metadata for deterministic agent follow-up
- [ ] Add agent integration tests for create -> transition -> comment -> history flow through `copilot_cli`
- [ ] Add non-interactive contract checks (`--json`, exit codes, structured errors, conflict handling)

---

## Appendix A: Schema-Aligned Architecture and Setup

### A1) Modeling Principles

- Keep ontology and storage concerns separate.
- Treat each board card as schema.org `Action`.
- Represent movement between columns as immutable transition facts (events), not destructive status overwrites.
- Keep schema.org semantics first; extend only where schema.org has no precise construct.
- Design so relational storage can map cleanly to RDF/triple representation later.

### A2) Conceptual Model (Ontology Layer)

- `Project` with `member` relationships for collaboration access.
- `Action` as the progressed unit shown on the board.
- `actionStatus` as canonical lifecycle status.
- `Comment` for user discussion, with threaded parent-child linkage.
- `Event`, `DigitalDocument`, `CreativeWork` as referenced context linked to `Action`.
- `BookmarkAction` can model saved personal view presets/deep links in future iterations.

### A3) Practical Postgres Model (Backend)

Core tables:

1. `action` (stable identity + editable content)
2. `action_transition_event` (append-only movement/audit log)
3. `action_state_projection` (current state snapshot for fast reads)
4. `workflow_state` and `workflow_transition` (workflow as data)
5. `project_member` (collaboration access)
6. `action_comment` (threaded comments)
7. `action_revision` (content change history)

Recommended fields (MVP-level):

1. `action`
   - `id`, `project_id`, `name`, `description`, `action_status`, `owner_user_id`,
     `owner_text`, `due_at`, `tags`, `object_ref`, `attributes`, `created_at`, `created_by`
2. `action_transition_event`
   - `id`, `ts`, `action_id`, `actor_id`, `from_status`, `to_status`, `reason`, `payload`,
     `correlation_id`
3. `action_state_projection`
   - `action_id`, `status`, `updated_at`, `last_event_id`
4. `project_member`
   - `project_id`, `user_id`, `role`, `added_at`, `added_by`
5. `action_comment`
   - `id`, `action_id`, `author_id`, `parent_comment_id`, `body`, `created_at`, `updated_at`
6. `action_revision`
   - `id`, `action_id`, `actor_id`, `diff`, `created_at`

Notes:

- `action_transition_event` is append-only and becomes the audit/provenance source.
- `action_state_projection` is rebuildable from events.
- No backward compatibility constraints are required (pre-release), so model can be introduced directly.

### A4) API/Service Shape

Command-side operations:

1. `createAction`
2. `updateActionFields` (quick edit and advanced edit)
3. `transitionActionStatus` (validates workflow, appends event, updates projection)
4. `addComment` / `replyComment`
5. `addProjectMember` / `removeProjectMember`

Query-side operations:

1. `listProjectActions` (list/board view from projection)
2. `getActionDetail` (references, comments, revisions)
3. `listActionHistory` (transitions + revisions timeline)

Concurrency:

- Use optimistic concurrency for transitions (`expected_last_event_id` or equivalent).
- Reject stale transitions with actionable UI feedback.

### A5) Frontend Alignment

- Board/list always render from projected `actionStatus`.
- Move operation calls transition command API (never writes status directly without command path).
- Quick edit on card: title, status move, assignee, due date, tags.
- Advanced panel: full description markdown editing, references, threaded comments, revision timeline.
- Project header holds inline settings and deep-linkable list/board routes.

### A6) CLI/SDK + Copilot Enablement

Collaboration flows must be first-class in both:

1. `senticor-copilot` CLI (and `copilot` alias)
2. `@project/core` SDK wrappers used by frontend and agent tooling

This epic depends on the platform contract in
[Epic: Platform SDK & Agent CLI](?path=/docs/product-epics-platform-sdk-agent-cli--docs),
but defines collaboration-specific command coverage and Copilot behavior.

#### A6.1) Required collaboration command surface

Read operations (must be available as CLI + SDK wrappers):

1. `projects list --json`
2. `projects get <project_id> --members --workflow --json`
3. `projects actions list --project=<project_id> [--status=<actionStatus>] [--tag=<tag>] [--assignee=<user_or_text>] [--due=overdue|today|upcoming] --json`
4. `projects actions get --project=<project_id> --action=<action_id> --comments --history --json`
5. `projects members list --project=<project_id> --json`

Write operations (must be available as CLI + SDK wrappers):

1. `projects members add --project=<project_id> --email=<registered_user_email> --role=member --apply --yes --json`
2. `projects members remove --project=<project_id> --user=<user_id> --apply --yes --json`
3. `projects actions create --project=<project_id> --name="<title>" [--description="<markdown>"] [--status=PotentialActionStatus] [--due=<iso8601>] [--assignee-user=<user_id>|--assignee-text="<name>"] [--tag=<tag>]... --apply --yes --json`
4. `projects actions update --project=<project_id> --action=<action_id> [--name=...] [--description=...] [--due=<iso8601>] [--assignee-user=<user_id>|--assignee-text=...] [--tag-add=<tag>] [--tag-remove=<tag>] --apply --yes --json`
5. `projects actions transition --project=<project_id> --action=<action_id> --to=<PotentialActionStatus|ActiveActionStatus|CompletedActionStatus|FailedActionStatus> --expected-last-event=<event_id> --correlation-id=<cid> --apply --yes --json`
6. `projects actions comments add --project=<project_id> --action=<action_id> --body="<markdown>" --apply --yes --json`
7. `projects actions comments reply --project=<project_id> --action=<action_id> --parent=<comment_id> --body="<markdown>" --apply --yes --json`

#### A6.2) Copilot tool-call contract

Copilot uses the single `copilot_cli` tool only (no direct route-specific tool explosion).

Invocation rules:

1. pass command as `argv: string[]` (never a shell string)
2. always include `--json`
3. always include `--non-interactive`
4. write commands run with `--apply --yes` only after user confirmation in approval UI
5. for status transitions, always pass `--expected-last-event` and a stable `--correlation-id`

Deterministic output requirements for agent use:

1. stdout returns one `copilot.v1` JSON envelope
2. stderr contains logs/warnings only
3. write responses include projection status and event metadata (`last_event_id`, `updated_at`, `correlation_id`)

#### A6.3) Minimal Copilot collaboration workflow

Copilot must be able to complete this workflow entirely via CLI/SDK:

1. discover project + collaborators (`projects get --members --workflow`)
2. list backlog work (`projects actions list --status=PotentialActionStatus`)
3. create a new action card (`projects actions create ...`)
4. move card to in-progress with optimistic concurrency (`projects actions transition ... --expected-last-event=...`)
5. add execution comment and verify history (`projects actions comments add`, then `projects actions get --history`)

If any step cannot run through `copilot_cli`, collaboration is not yet Copilot-ready.

#### A6.4) Validation and safety requirements

1. all writes enforce actor identity, org/project scope, and role checks at backend boundary
2. all writes carry correlation IDs for traceability across CLI, agent, and backend logs
3. stale transition attempts return conflict semantics (non-zero exit + structured error envelope)
4. unregistered collaborator emails fail fast with actionable validation errors

### A7) Schema Compliance Boundary

Use schema.org terms directly where available:

1. `Project`, `member`
2. `Action`, `actionStatus`
3. `Comment`
4. `Event`, `DigitalDocument`, `CreativeWork`
5. `BookmarkAction` (optional saved-view capability)

Extend with product namespace only for workflow internals not covered by schema.org:

1. transition-event envelope fields
2. workflow policy/guard metadata
3. projection bookkeeping

### A8) Initial Setup Sequence

- [x] Add DB tables for `action_transition_event`, `action_state_projection`, `project_member`,
  `action_comment`, `action_revision`, workflow policy tables.
- [x] Implement transition command service + workflow validator.
- [ ] Implement projection updater + rebuild tool from event log.
- [x] Wire list/board APIs to projection reads.
- [ ] Wire UI quick edit + advanced edit panel to command/query APIs.
- [ ] Add preflight checks for docs + Storybook indexing and collaboration flow tests.

---

## Definition of Done

- [ ] Acceptance criteria implemented and tested for owner/member scenarios.
- [ ] Permission boundaries verified on backend routes and frontend guards.
- [ ] Accessibility checks pass for board navigation and card movement actions.
- [ ] List and kanban remain consistent views of action items via `actionStatus`.
- [x] Workflow policy is data-driven and supports future restricted transitions.
- [ ] Deep links restore project and view context reliably.
- [ ] Due dates, tags, assignees, and comments are usable from quick edit on cards.
- [x] Threaded comments and revision history capture actor/time for collaboration auditability.
- [ ] Product docs and export order include this epic.
- [ ] CLI/SDK collaboration operations are documented and executable with deterministic machine output.
- [ ] Copilot can run an end-to-end collaboration workflow through `copilot_cli` without manual API wiring.
