import { Meta } from "@storybook/addon-docs/blocks";

<Meta title="Product/Epics/Internationalization & Localization" />

# Epic: Internationalization & Localization (i18n/l10n)

**Status:** Draft
**Last updated:** 2026-02-26
**Priority:** Current
**Design direction:** Universal date/time format + bilingual UI text (de/en)
**Depends on:** None
**Related:** [ADR-005: Custom i18n](?path=/docs/engineering-adr-005-custom-i18n-over-framework--docs), [Engineering / i18n](?path=/docs/engineering-i18n--docs)

---

## Context

The app has significant i18n infrastructure that is **built but disconnected**:

| What exists                                                                     | Where                                      | Problem                                                                                             |
| ------------------------------------------------------------------------------- | ------------------------------------------ | --------------------------------------------------------------------------------------------------- |
| `UserPreferences` type with `language`, `dateFormat`, `timeFormat`, `weekStart` | `model/settings-types.ts`                  | Preferences are never read by any component                                                         |
| `PreferencesPanel` UI with dropdowns for all settings                           | `components/settings/PreferencesPanel.tsx` | Settings panel uses a local `useState` in `SettingsScreen.tsx:155` — changes are lost on navigation |
| `useUserPreferences` hook with localStorage persistence                         | `hooks/use-user-preferences.ts`            | Never used by `SettingsScreen` — the hook exists but the screen ignores it                          |
| `getMessage(key, locale?)` with 28 message keys                                 | `lib/messages.ts`                          | Reads `navigator.language` instead of user preference; only 28 of ~100+ needed keys exist           |
| Copilot API locale context                                                      | `hooks/use-copilot-api.ts:133`             | Sends `navigator.language`, ignoring user preference                                                |

Additionally, **9+ scattered date/time formatters** exist across components, each hardcoded to different locales:

| Component                                   | Hardcoded locale                                         | Function                       |
| ------------------------------------------- | -------------------------------------------------------- | ------------------------------ |
| `chat/ConversationList.tsx`                 | German strings (`"Gerade eben"`, `"Vor N Min."`)         | `formatRelativeDate`           |
| `work/EditableTitle.tsx`                    | English strings (`"just now"`, `"5m ago"`)               | `formatRelativeTime`           |
| `work/ActionRow.tsx`                        | English strings (`"today"`, `"tomorrow"`, `"(overdue)"`) | `formatDueDate`                |
| `settings/ImportJobRow.tsx`                 | `"de-DE"`                                                | `formatTime`                   |
| `settings/DuplicateImportWarning.tsx`       | `"de-DE"`                                                | `formatDate`                   |
| `settings/AgentSetupPanel.tsx`              | `"en-US"` / browser default                              | `formatUsd`, `formatCheckedAt` |
| `settings/OrganizationsPanel.tsx`           | browser default                                          | inline `.toLocaleDateString()` |
| `settings/EmailConnectionCard.tsx`          | German strings                                           | `formatRelativeTime`           |
| `imports/shared/ImportSummaryBreakdown.tsx` | browser default                                          | inline `.toLocaleString()`     |

**Problem:** The user works in both German and English contexts. Switching between date formats is confusing. UI text mixes languages inconsistently.

**Outcome:** A unified, predictable experience where dates and times always use the same universal format, UI text is consistently in the user's chosen language, and all preferences are persisted and respected.

---

## User Story

> "I want to set my preferred language once in Settings, have all UI text switch to that language,
> and never have to think about date formats — they should always be the same clear, unambiguous format
> regardless of language."

---

## Key Design Decisions

### 1. Universal date/time format (no locale-dependent formatting)

All dates and times use **one universal format** everywhere:

| What          | Format                  | Example                         |
| ------------- | ----------------------- | ------------------------------- |
| Date          | `YYYY-MM-DD` (ISO 8601) | `2026-02-26`                    |
| Time          | `HH:mm` (24h)           | `14:30`                         |
| Date + time   | `YYYY-MM-DD HH:mm`      | `2026-02-26 14:30`              |
| Relative time | Language-dependent      | `"5 Min. ago"` / `"vor 5 Min."` |

**Rationale:** ISO 8601 is unambiguous, sorts correctly, and works for any user in any language.
This eliminates `DateFormat` and `TimeFormat` as user preferences — one less thing to configure.

### 2. Two languages only: German (de) and English (en)

No `en-GB`, `en-DE`, or other variants. The universal date format removes the need for
locale-specific formatting. Language choice only affects UI text and relative time strings.

### 3. Simplified preferences

Remove `dateFormat`, `timeFormat` from `UserPreferences`. Keep:

- `language: "de" | "en"` — UI text language
- `weekStart: "monday" | "sunday"` — for future calendar views
- `defaultBucket`, `theme`, `weeklyReviewEnabled`, `weeklyReviewDay` — unchanged

### 4. Browser detection with Settings override

On first visit, detect language from `navigator.language`. User can override in Settings → Preferences.
Preference is persisted to `localStorage` and shared via React context.

---

## MVP Scope

### 1) Locale context and formatting library (Phase 1)

- Create `LocaleProvider` React context — single source of truth for language preference
- Create `format-locale.ts` — centralized pure formatting functions using native `Intl.*` APIs:
  - `formatDate(iso)` → always `YYYY-MM-DD`
  - `formatDateTime(iso)` → always `YYYY-MM-DD HH:mm`
  - `formatTime(date)` → always `HH:mm`
  - `formatRelativeTime(iso, lang)` → `"just now"` / `"gerade eben"`, language-dependent
  - `formatDueDate(dueDate, lang)` → `"today"` / `"heute"` + className, language-dependent
  - `formatDuration(startIso, endIso)` → `"2m 15s"` (universal)
  - `formatNumber(value)` → plain number formatting
  - `formatCurrency(value, currency)` → `"$12.34"` / `"12,34 $"`
- Create `useFormat()` hook — bound formatters using current language from context
- Evolve `getMessage()` with simple `{param}` interpolation support
- Wire `LocaleProvider` into the app provider tree

**Acceptance criteria:**

- [ ] `LocaleProvider` shares language preference across the app
- [ ] Browser language auto-detection on first visit
- [ ] All formatting functions pass tests for both `de` and `en`
- [ ] All existing tests pass (additive only)

### 2) Wire components to formatting library (Phase 2)

- Remove all 9+ local formatting functions from components
- Replace with `useFormat()` hook calls
- Update `use-copilot-api.ts` to send user's language preference instead of `navigator.language`

**Acceptance criteria:**

- [ ] Zero hardcoded locale strings (`"de-DE"`, `"en-US"`) in component files
- [ ] Zero local format functions in components
- [ ] Switching language changes all relative time strings and due date labels

### 3) Localize UI strings (Phase 3)

Expand `messages.ts` with ~80-100 new message keys covering all hardcoded UI text:

| Domain        | Examples                                                | ~Keys |
| ------------- | ------------------------------------------------------- | ----- |
| Buckets       | "Inbox"/"Eingang", "Focus"/"Fokus"                      | 8     |
| Work/actions  | "Archive"/"Archivieren", action subtype labels          | 20    |
| Due dates     | "today"/"heute", "(overdue)"/"(überfällig)"             | 5     |
| Relative time | "just now"/"gerade eben", `"{n}m ago"`/`"vor {n} Min."` | 6     |
| Settings      | "Preferences"/"Einstellungen", all tab and field labels | 20    |
| Agent setup   | "Active"/"Aktiv", "Save"/"Speichern"                    | 10    |
| Chat          | "Send"/"Senden", "New conversation"/"Neue Unterhaltung" | 5     |
| Provenance    | "AI suggested"/"KI-Vorschlag"                           | 5     |
| Common        | "Cancel"/"Abbrechen", "Loading..."/"Laden..."           | 10    |

**Acceptance criteria:**

- [ ] No hardcoded German or English user-facing strings in component files
- [ ] Both `de` and `en` translations exist for every key
- [ ] Switching language in Settings changes all UI text

### 4) Fix Settings and complete UX (Phase 4)

- Fix broken preferences wiring in `SettingsScreen.tsx:155` — replace local `useState` with `useLocale()` from context
- Remove `dateFormat` and `timeFormat` dropdowns from `PreferencesPanel`
- Localize all PreferencesPanel labels via `getMessage()`
- Ensure preferences persist to localStorage and are respected everywhere

**Acceptance criteria:**

- [ ] Preferences are persisted (survive navigation and page reload)
- [ ] Language dropdown shows "Deutsch" / "English"
- [ ] All Settings labels are in the selected language
- [ ] First-time users get language auto-detected from browser

---

## Interaction Model

### Language switch flow

1. User opens Settings → Preferences
2. Changes Language from "Deutsch" to "English"
3. **Immediately** all UI text switches to English (no page reload)
4. Dates and times remain in `YYYY-MM-DD HH:mm` format (unchanged)
5. Relative time strings switch: "vor 5 Min." → "5m ago"
6. Preference is persisted to localStorage
7. Copilot chat context sends `locale: "en"` to backend

### First visit flow

1. App detects `navigator.language`
2. If it starts with `"de"` → default to German
3. Otherwise → default to English
4. User can override anytime in Settings

---

## Technical Notes

### What gets simplified

- Remove `DateFormat = "DD.MM.YYYY" | "YYYY-MM-DD" | "MM/DD/YYYY"` type
- Remove `TimeFormat = "24h" | "12h"` type
- Remove `dateFormat` and `timeFormat` from `UserPreferences`
- Remove date/time format dropdowns from `PreferencesPanel`

### What stays from ADR-005

The custom `getMessage()` pattern stays — no migration to react-intl or i18next.
ADR-005 will be updated to reflect:

- Interpolation support added (`{param}` syntax)
- Scaled to ~100+ keys (organized by domain)
- Still zero external dependencies

### Files to create

| File                          | Purpose                                                 |
| ----------------------------- | ------------------------------------------------------- |
| `lib/locale-context.tsx`      | React context + `LocaleProvider` + `useLocale()`        |
| `lib/format-locale.ts`        | Centralized formatting functions                        |
| `hooks/use-format.ts`         | Convenience hook binding formatters to current language |
| `lib/format-locale.test.ts`   | Formatting tests                                        |
| `lib/locale-context.test.tsx` | Context/provider tests                                  |
| `hooks/use-format.test.tsx`   | Hook tests                                              |

### Files to modify

| File                                        | Change                                                          |
| ------------------------------------------- | --------------------------------------------------------------- |
| `model/settings-types.ts`                   | Remove `DateFormat`, `TimeFormat`; keep `Language`, `WeekStart` |
| `lib/messages.ts`                           | Add interpolation + ~80-100 new keys                            |
| `components/shell/AppBootstrap.tsx`         | Wire `LocaleProvider`                                           |
| `components/settings/SettingsScreen.tsx`    | Fix line 155: use context instead of local useState             |
| `components/settings/PreferencesPanel.tsx`  | Remove date/time dropdowns, localize labels                     |
| 9 component files                           | Replace local formatters with `useFormat()`                     |
| `hooks/use-copilot-api.ts`                  | Use language from context                                       |
| `docs/engineering/adr/Adr005CustomI18n.mdx` | Update ADR status and consequences                              |
| `docs/engineering/I18n.mdx`                 | Update documentation                                            |

---

## Delivery Plan

### Phase 1: Locale foundation

- [ ] Create `format-locale.test.ts` (TDD — tests first)
- [ ] Create `format-locale.ts` (make tests green)
- [ ] Create `locale-context.test.tsx`
- [ ] Create `locale-context.tsx` + `LocaleProvider`
- [ ] Create `use-format.test.tsx`
- [ ] Create `use-format.ts`
- [ ] Evolve `getMessage()` with interpolation
- [ ] Wire `LocaleProvider` into `AppBootstrap.tsx`
- [ ] Simplify `settings-types.ts` (remove DateFormat, TimeFormat)

### Phase 2: Wire components

- [ ] Replace formatters in `ConversationList.tsx`
- [ ] Replace formatters in `EditableTitle.tsx`
- [ ] Replace formatters in `ActionRow.tsx`
- [ ] Replace formatters in `ImportJobRow.tsx`
- [ ] Replace formatters in `DuplicateImportWarning.tsx`
- [ ] Replace formatters in `AgentSetupPanel.tsx`
- [ ] Replace formatters in `OrganizationsPanel.tsx`
- [ ] Replace formatters in `EmailConnectionCard.tsx`
- [ ] Replace formatters in `ImportSummaryBreakdown.tsx`
- [ ] Update `use-copilot-api.ts` locale

### Phase 3: Localize UI strings

- [ ] Add bucket label message keys
- [ ] Add work/action message keys
- [ ] Add settings message keys
- [ ] Add chat message keys
- [ ] Add common message keys
- [ ] Replace hardcoded strings in all components
- [ ] Add completeness test (all keys have both de and en)

### Phase 4: Fix Settings UX

- [ ] Fix `SettingsScreen.tsx:155` — shared context
- [ ] Remove date/time format dropdowns
- [ ] Localize PreferencesPanel labels
- [ ] Browser detection in LocaleProvider
- [ ] End-to-end manual verification

### Phase 5: Agent i18n

Localize the OpenClaw agent's system prompt and skill files so the agent responds in the user's preferred language.

- [ ] `openclaw/workspace/AGENTS.md` — localized version or language-detection instructions
- [ ] `openclaw/workspace/skills/*/SKILL.md` — localized skill files (or keep English with language-aware response rules)
- [ ] Agent receives user's language preference via chat context or environment variable
- [ ] Agent responds in the user's selected language (de/en), not hardcoded
- [ ] Haystack system prompt `agents/prompts/de/copilot_system.j2` — add English variant or make language-conditional

---

## Appendix: Current Hardcoded Strings Audit

### German-only strings (need English translations)

```
ConversationList.tsx:   "Gerade eben", "Vor N Min.", "Vor N Std.", "Vor N Tag(en)"
EmailConnectionCard.tsx: "gerade eben", "vor N Min.", "vor N Std."
ActionRow.tsx:          "Kaufen", "Planen", "Kommunizieren", "Prufen", "Erstellen", "Senden", "Lesen"
ActionRow.tsx:          "Typ andern", "Kein Typ"
ActionList.tsx:         Duplicated SUBTYPE_LABELS
AgentSetupPanel.tsx:    "Aktiv", "Gestoppt", "Startet...", "Fehler", "Nicht gestartet"
App.tsx:                "Chat offnen" (aria-label)
ChatInput.tsx:          "Senden" (aria-label)
```

### English-only strings (need German translations)

```
EditableTitle.tsx:      "just now", "Nm ago", "Nh ago", "Nd ago"
EditableTitle.tsx:      "AI suggested", "User edited", "System renamed"
EditableTitle.tsx:      "Title (optional)", "Captured text", "Add title"
ActionRow.tsx:          "today", "tomorrow", "(overdue)"
ActionRow.tsx:          "Archive", "Move to ...", "More options", "Less options", "Cancel"
PreferencesPanel.tsx:   "Language & Regional", "Time format", "Date format", "Week start"
PreferencesPanel.tsx:   "Display", "Default view", "Theme", "Review", "Weekly review reminder"
SettingsScreen.tsx:     "Import / Export", "Email", "Labels", "Organizations", "Preferences"
ImportJobRow.tsx:       "Queued", "Running", "Completed", "Failed"
DuplicateImportWarning: "This file was already imported", "Import anyway", "Cancel"
OrganizationsPanel.tsx: "Organizations", "Add organization", "Create", "Cancel"
```

### Swipe triage strings (English-only, need German translations)

Added by the [Swipe Triage epic](?path=/docs/product-epics-swipe-triage-and-touch-gestures--docs):

```
SwipeableRow.tsx:      "Swipe right for {label}, left for {label}" (aria-label)
ActionList.tsx:        "Quick Triage", "Undo", "selected", "All", "Clear"
ActionList.tsx:        "Start quick triage" (aria-label), "Batch move to {label}" (aria-labels)
QuickTriageView.tsx:   "Quick Triage", "Close quick triage", "Inbox empty — well done!"
QuickTriageView.tsx:   "Waiting", "Next" (swipe hints), "Card {n} of {total}: {title}" (aria)
TriageSheet.tsx:       "Next", "Waiting", "Calendar", "Later", "Reference", "Archive"
TriageSheet.tsx:       "Triage: {itemName}" (aria-label)
TriageCard.tsx:        Item display name, description, tags
```
