import { Meta } from "@storybook/addon-docs/blocks";

<Meta title="Product/Epics/Copilot HITL Retry Loop" />

# Epic: Copilot HITL Retry Loop (3 Attempts)

**Status:** Draft
**Priority:** Current
**Checklist audit:** February 25, 2026 -- initial scope only; all implementation items remain unchecked.
**Last updated:** 2026-02-25
**Depends on:** Existing suggestion approval flow, `/chat/execute-tool` contract, agents `copilot_cli` executor
**Related:** [Completed Epic: Copilot V2+](?path=/docs/product-completed-epics-copilot-v2--docs), [Engineering: Agents Service](?path=/docs/engineering-agents-service--docs)

## Context

Today, approved tool calls are executed as a single fire-and-forget request. If execution fails,
the UI usually reverts the suggestion to pending, but the system does not run a structured
repair loop with explicit checkpoints and user confirmation between attempts.

### Current behavior gap

1. No retry budget bound to the same suggestion execution.
2. No structured error feedback loop back into agent reasoning.
3. No checkpointed "confirm corrected action" step between retries.
4. `Accept all` runs in parallel, which conflicts with checkpointed repair.

## User Story

> "When Copilot proposes a change and execution fails, I want Copilot to explain the failure,
> propose a corrected action, and ask me again, up to three attempts, before giving up."

## Goals

1. Add explicit retry loop with a max of 3 attempts per approved suggestion.
2. Feed tool execution errors back into agent reasoning for repaired tool calls.
3. Enforce human-in-the-loop confirmation at each retry checkpoint.
4. Preserve deterministic execution logging and auditable attempt history.
5. Keep existing success path fast and unchanged for first-attempt success.

## Out of Scope

- Automatic retries without user confirmation for write operations.
- Multi-agent negotiation for tool repair.
- Unlimited retries or background autonomous retries.
- Replacing `copilot_cli` with a new tool family in this epic.

## MVP Scope

### 1) Tool-run state machine

Each approved suggestion execution is tracked as one run:

- `awaiting_confirmation`
- `executing`
- `needs_retry_confirmation`
- `succeeded`
- `failed`

Run record includes:

- `conversationId`
- suggestion/tool-call payload
- `attempt` (1..3)
- normalized error payload (code, message, stderr excerpt)
- last repaired candidate tool call
- timestamps and actor metadata

### 2) Retry policy

- Max attempts: **3**
- Retry only on retryable classes:
  - CLI argument/validation errors
  - transient service/transport failures
- Fail fast (no retry) on non-retryable classes:
  - auth/permission denied
  - explicit user rejection
  - malformed payload that cannot be repaired

### 3) Error feedback -> agent repair

On failed attempt 1 or 2:

1. Build structured repair prompt with:
   - previous tool call
   - normalized failure detail
   - constraints for valid command schema
2. Generate one repaired candidate tool call.
3. Return checkpoint payload to UI for confirmation.

### 4) HITL checkpoints in UI

Suggestion card behavior:

- Show `Attempt X / 3` when in retry flow.
- Show user-readable failure reason.
- Show repaired proposal summary with expandable technical details.
- Require explicit user action:
  - `Ãœbernehmen` -> next attempt executes
  - `Verwerfen` -> run stops as failed by user

### 5) `Accept all` semantics

When any selected suggestion enters checkpointed retry:

- execution must become sequential for that batch
- each checkpoint must be confirmed before the next attempt

## API Contract Changes (MVP)

`POST /chat/execute-tool` (or a versioned sibling) returns one of:

1. `succeeded`
   - `createdItems`
2. `checkpoint`
   - `attempt`
   - `maxAttempts`
   - `errorFeedback`
   - `candidateToolCall`
3. `failed`
   - `attempt`
   - `errorFeedback`
   - `final: true`

The frontend must not infer retry state from generic HTTP 500 text anymore.

## Acceptance Criteria

- [ ] First-attempt success still returns confirmation with no extra steps.
- [ ] On retryable failure at attempt 1 or 2, user sees checkpoint and corrected proposal.
- [ ] Confirming checkpoint executes next attempt with updated tool call.
- [ ] Maximum 3 attempts are enforced.
- [ ] After attempt 3 failure, run is marked failed with clear error summary.
- [ ] Non-retryable failures skip retry loop and return immediate failed state.
- [ ] `Accept all` does not bypass required checkpoint confirmations.
- [ ] Attempt history is persisted and visible in logs/trace context.

## Implementation Slices

### Slice A: Backend orchestration

- Add run state model + transition logic.
- Normalize and classify tool errors.
- Return structured checkpoint/failed responses.

### Slice B: Agents repair endpoint/path

- Add repair routine that converts error feedback into candidate tool call.
- Validate candidate against `copilot_cli` contract before returning.

### Slice C: Frontend chat state + cards

- Extend suggestion state with attempt/checkpoint metadata.
- Render checkpoint UX and action buttons.
- Update accept/accept-all flow to handle checkpoint states.

### Slice D: Observability + quality

- Structured logs for each attempt and transition.
- Metrics: retry rate, success-after-retry, fail-after-3.
- Unit + integration tests across backend, agents, and frontend hooks.

## Test Plan

- Backend:
  - state transition tests for success, retry, exhausted, user-dismissed
  - retryable vs non-retryable classification tests
- Agents:
  - repair output schema validation tests
  - fallback behavior when repair generation fails
- Frontend:
  - hook tests for checkpoint progression and attempt counter
  - suggestion card rendering tests for checkpoint states
- End-to-end:
  - seeded failing command repaired on second attempt
  - exhausted flow (3 failures) with clear terminal status

## Rollout

1. Ship behind feature flag `copilot.hitl_retry_loop_v1`.
2. Enable internal orgs first.
3. Monitor retry metrics + error classes.
4. Remove flag after stability criteria are met.
