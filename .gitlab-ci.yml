include:
  - template: Jobs/SAST.gitlab-ci.yml

# Override SAST template: assign to our runner tag + stage
sast:
  stage: build
  tags:
    - large

stages:
  - quality      # 6 jobs: lint + typecheck (+ agents)
  - unit         # 4 jobs: no infrastructure
  - integration  # 2 jobs: backend (Postgres), frontend-contract (no infra)
  - build        # 3 jobs: docker images + SAST (main only)
  - e2e          # 1 job: full stack Playwright (main only)
  - push         # 3 jobs: push to Harbor (main only)
  - deploy       # 1 job: update k8s manifests (main only)
  - smoke        # 1 job: e2e against deployed instance (nightly + manual)

variables:
  # Pre-built CI image with Node 24 + Python 3.12 + Playwright + uv.
  # Rebuild on demand: glab ci run --variables BUILD_CI_IMAGE:true
  # Pushed to Harbor; runner authenticates via DOCKER_AUTH_CONFIG below.
  HARBOR_REGISTRY: harbor.100-114-108-51.nip.io:30443
  CI_NODE_PYTHON_IMAGE: ${HARBOR_REGISTRY}/project/ci:latest
  # Docker pull auth for Harbor (allows runner to pull CI_NODE_PYTHON_IMAGE)
  DOCKER_AUTH_CONFIG: '{"auths":{"${HARBOR_REGISTRY}":{"username":"${HARBOR_USER}","password":"${HARBOR_PASSWORD}"}}}'
  # Cache directories (must be inside $CI_PROJECT_DIR for GitLab cache)
  npm_config_cache: '$CI_PROJECT_DIR/.npm-cache'

.default-rules:
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH

.backend-postgres:
  services:
    - name: postgres:16
      alias: postgres
  variables:
    POSTGRES_USER: project
    POSTGRES_PASSWORD: ci_test_password
    POSTGRES_DB: project
    DATABASE_URL: "postgresql://project:ci_test_password@postgres:5432/project"
    VITE_API_BASE_URL: "http://localhost:8000"
    MEILI_URL: ""

.large-runner:
  tags:
    - large

.retry-infra:
  retry:
    max: 2
    when:
      - runner_system_failure
      - stuck_or_timeout_failure
      - scheduler_failure

.failure-issue:
  after_script:
    - chmod +x ci/handle-failure-issue.sh && ci/handle-failure-issue.sh

# --- Caching templates ---

.frontend-cache:
  cache:
    - key:
        files: [frontend/package-lock.json]
      paths: [.npm-cache/]
      policy: pull-push

.frontend-cache-readonly:
  cache:
    - key:
        files: [frontend/package-lock.json]
      paths: [.npm-cache/]
      policy: pull

.backend-cache:
  cache:
    - key:
        files: [backend/uv.lock]
      paths: [backend/.venv/]
      policy: pull-push

.backend-cache-readonly:
  cache:
    - key:
        files: [backend/uv.lock]
      paths: [backend/.venv/]
      policy: pull

.agents-cache:
  cache:
    - key:
        files: [agents/uv.lock]
      paths: [agents/.venv/]
      policy: pull-push

.agents-cache-readonly:
  cache:
    - key:
        files: [agents/uv.lock]
      paths: [agents/.venv/]
      policy: pull

.fullstack-cache:
  cache:
    - key:
        files: [frontend/package-lock.json]
      paths: [.npm-cache/]
      policy: pull-push
    - key:
        files: [backend/uv.lock]
      paths: [backend/.venv/]
      policy: pull-push

.fullstack-cache-readonly:
  cache:
    - key:
        files: [frontend/package-lock.json]
      paths: [.npm-cache/]
      policy: pull
    - key:
        files: [backend/uv.lock]
      paths: [backend/.venv/]
      policy: pull

# ==================== CI IMAGE (on-demand only: run with BUILD_CI_IMAGE=true) ====================

build-ci-image:
  stage: quality
  image:
    name: gcr.io/kaniko-project/executor:v1.23.2-debug
    entrypoint: [""]
  extends: .large-runner
  before_script:
    - mkdir -p /kaniko/.docker
    - AUTH_B64="$(printf '%s:%s' "$HARBOR_USER" "$HARBOR_PASSWORD" | base64 | tr -d '\n')"
    - printf '{"auths":{"%s":{"auth":"%s"}}}\n' "$HARBOR_REGISTRY" "$AUTH_B64" > /kaniko/.docker/config.json
  script:
    - /kaniko/executor --context "$CI_PROJECT_DIR/ci" --dockerfile "$CI_PROJECT_DIR/ci/Dockerfile.ci" --destination "${HARBOR_REGISTRY}/project/ci:latest" --insecure --skip-tls-verify
  rules:
    - if: $BUILD_CI_IMAGE == "true"

# ==================== QUALITY (8 jobs: lint + typecheck + docs drift + migration policy + agents) ====================

docs-drift:
  stage: quality
  needs: []
  image: $CI_NODE_PYTHON_IMAGE
  extends: [.default-rules, .retry-infra, .failure-issue]
  script:
    - bash scripts/check-doc-drift.sh

frontend-lint:
  stage: quality
  needs: []
  image: $CI_NODE_PYTHON_IMAGE
  extends: [.default-rules, .retry-infra, .failure-issue, .frontend-cache]
  before_script:
    - cd frontend && npm ci --ignore-scripts --silent
  script:
    - npm run lint

frontend-typecheck:
  stage: quality
  needs: []
  image: $CI_NODE_PYTHON_IMAGE
  extends: [.default-rules, .retry-infra, .failure-issue, .frontend-cache]
  before_script:
    - cd frontend && npm ci --ignore-scripts --silent
  script:
    - npm run type-check

backend-lint:
  stage: quality
  needs: []
  image: $CI_NODE_PYTHON_IMAGE
  extends: [.default-rules, .retry-infra, .failure-issue, .backend-cache]
  before_script:
    - cd backend && uv sync --quiet --all-groups --all-extras
  script:
    - uv run ruff check .

backend-typecheck:
  stage: quality
  needs: []
  image: $CI_NODE_PYTHON_IMAGE
  extends: [.default-rules, .retry-infra, .failure-issue, .backend-cache]
  before_script:
    - cd backend && uv sync --quiet --all-groups --all-extras
  script:
    - uv run mypy app/

agents-lint:
  stage: quality
  needs: []
  image: $CI_NODE_PYTHON_IMAGE
  extends: [.default-rules, .retry-infra, .failure-issue, .agents-cache]
  before_script:
    - cd agents && uv sync --quiet --all-groups
  script:
    - uv run ruff check .

agents-typecheck:
  stage: quality
  needs: []
  image: $CI_NODE_PYTHON_IMAGE
  extends: [.default-rules, .retry-infra, .failure-issue, .agents-cache]
  before_script:
    - cd agents && uv sync --quiet --all-groups
  script:
    - uv run mypy .

backend-migration-policy:
  stage: quality
  needs: []
  image: $CI_NODE_PYTHON_IMAGE
  extends: [.default-rules, .retry-infra, .failure-issue]
  script:
    - bash scripts/check-alembic-policy.sh

# ==================== UNIT (4 jobs: no infrastructure, gated by quality) ====================

frontend-unit:
  stage: unit
  image: $CI_NODE_PYTHON_IMAGE
  extends: [.default-rules, .large-runner, .retry-infra, .failure-issue, .frontend-cache-readonly]
  before_script:
    - cd frontend && npm ci --ignore-scripts --silent
  script:
    - CI=1 npx vitest run --project=unit --coverage --coverage.reporter=text --coverage.reporter=cobertura --coverage.reporter=json-summary --coverage.reportsDirectory=coverage/unit
  artifacts:
    when: always
    paths:
      - frontend/coverage/unit/
    reports:
      coverage_report:
        coverage_format: cobertura
        path: frontend/coverage/unit/cobertura-coverage.xml
  coverage: '/All files[^|]*\|[^|]*\s([0-9]+(?:\.[0-9]+)?)\s/'

frontend-storybook:
  stage: unit
  image: $CI_NODE_PYTHON_IMAGE
  extends: [.default-rules, .large-runner, .retry-infra, .failure-issue, .frontend-cache-readonly]
  before_script:
    - cd frontend && npm ci --silent
  script:
    - STORYBOOK_TESTS=1 CI=1 npx vitest run --project=storybook

backend-unit:
  stage: unit
  image: $CI_NODE_PYTHON_IMAGE
  extends: [.default-rules, .retry-infra, .failure-issue, .backend-cache-readonly]
  before_script:
    - cd backend && uv sync --quiet --all-groups --all-extras
  script:
    - uv run pytest -m unit -q --maxfail=1

agents-unit:
  stage: unit
  image: $CI_NODE_PYTHON_IMAGE
  extends: [.default-rules, .retry-infra, .failure-issue, .agents-cache]
  before_script:
    - cd agents && uv sync --quiet
  script:
    - uv run pytest tests/ -q

# ==================== INTEGRATION (2 jobs: Postgres only for backend) ====================

backend-integration:
  stage: integration
  image: $CI_NODE_PYTHON_IMAGE
  extends: [.default-rules, .large-runner, .retry-infra, .backend-postgres, .failure-issue, .backend-cache-readonly]
  before_script:
    - cd backend && uv sync --quiet --all-groups --all-extras
  script:
    - uv run pytest -m "not unit" -q --maxfail=3 --cov=app --cov-report=term-missing --cov-report=xml:coverage/integration.xml --cov-report=html:coverage/integration
  artifacts:
    when: always
    paths:
      - backend/coverage/integration/
    reports:
      coverage_report:
        coverage_format: cobertura
        path: backend/coverage/integration.xml
  coverage: '/TOTAL.*\s+([0-9]+%)$/'

frontend-contract:
  stage: integration
  image: $CI_NODE_PYTHON_IMAGE
  extends: [.default-rules, .retry-infra, .failure-issue, .fullstack-cache-readonly]
  before_script:
    - cd $CI_PROJECT_DIR/backend && uv sync --quiet --all-groups --all-extras
    - cd $CI_PROJECT_DIR/frontend && npm ci --ignore-scripts --silent
  script:
    - cd $CI_PROJECT_DIR/backend && uv run python scripts/export_schemas.py
    - cd $CI_PROJECT_DIR/frontend && CI=1 npx vitest run --project=unit -t "JSON Schema contract"

# ==================== BUILD (3 jobs: docker images, gated by integration) ====================

.build-base:
  stage: build
  image:
    name: gcr.io/kaniko-project/executor:v1.23.2-debug
    entrypoint: [""]
  extends: .large-runner
  rules:
    - if: $CI_COMMIT_BRANCH == "main"

build-frontend:
  extends: .build-base
  script:
    - /kaniko/executor --context "$CI_PROJECT_DIR" --dockerfile "$CI_PROJECT_DIR/frontend/Dockerfile" --no-push --tarPath /tmp/frontend.tar
  artifacts:
    paths: [/tmp/frontend.tar]
    expire_in: 1 hour

build-backend:
  extends: .build-base
  script:
    - /kaniko/executor --context "$CI_PROJECT_DIR" --dockerfile "$CI_PROJECT_DIR/backend/Dockerfile" --no-push --tarPath /tmp/backend.tar
  artifacts:
    paths: [/tmp/backend.tar]
    expire_in: 1 hour

build-storybook:
  extends: .build-base
  script:
    - /kaniko/executor --context "$CI_PROJECT_DIR" --dockerfile "$CI_PROJECT_DIR/frontend/Dockerfile.storybook" --build-arg STORYBOOK_BASE=/storybook/ --no-push --tarPath /tmp/storybook.tar
  artifacts:
    paths: [/tmp/storybook.tar]
    expire_in: 1 hour

# ==================== E2E (1 job: full stack Playwright, gated by build) ====================

e2e:
  stage: e2e
  image: $CI_NODE_PYTHON_IMAGE
  extends: [.large-runner, .retry-infra, .backend-postgres, .failure-issue, .fullstack-cache-readonly]
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
  cache:
    - key:
        files: [frontend/package-lock.json]
      paths: [.npm-cache/]
      policy: pull
    - key:
        files: [backend/uv.lock]
      paths: [backend/.venv/]
      policy: pull
    - key:
        files: [agents/uv.lock]
      paths: [agents/.venv/]
      policy: pull
  before_script:
    - cd $CI_PROJECT_DIR/backend && uv sync --quiet --all-groups --all-extras
    - cd $CI_PROJECT_DIR/agents && uv sync --quiet
    - cd $CI_PROJECT_DIR/frontend && npm ci --ignore-scripts --silent
  script:
    # 1. Initialize database
    - cd $CI_PROJECT_DIR/backend && uv run python -m app.db_init
    # 2. Start backend
    - cd $CI_PROJECT_DIR/backend && uv run uvicorn app.main:app --host 0.0.0.0 --port 8000 &
    - |
      BACKEND_READY=0
      for i in $(seq 1 30); do
        if curl -sf http://localhost:8000/health > /dev/null 2>&1; then
          echo "Backend is ready"
          BACKEND_READY=1
          break
        fi
        sleep 1
      done
      if [ "$BACKEND_READY" -ne 1 ]; then
        echo "Backend failed to become ready"
        exit 1
      fi
    # 3. Start outbox worker (needed for import e2e tests)
    - cd $CI_PROJECT_DIR/backend && uv run python -m app.worker --loop &
    # 4. Start agents
    - cd $CI_PROJECT_DIR/agents && uv run uvicorn app:app --host 0.0.0.0 --port 8002 &
    - |
      AGENTS_READY=0
      for i in $(seq 1 15); do
        if curl -sf http://localhost:8002/health > /dev/null 2>&1; then
          echo "Agents service is ready"
          AGENTS_READY=1
          break
        fi
        sleep 1
      done
      if [ "$AGENTS_READY" -ne 1 ]; then
        echo "Agents service failed to become ready (non-fatal, continuing)"
      fi
    # 5. Start frontend
    - cd $CI_PROJECT_DIR/frontend && npm run dev -- --host 0.0.0.0 --port 5173 &
    - |
      FRONTEND_READY=0
      for i in $(seq 1 60); do
        if curl -sf http://localhost:5173 > /dev/null 2>&1; then
          echo "Frontend is ready"
          FRONTEND_READY=1
          break
        fi
        sleep 1
      done
      if [ "$FRONTEND_READY" -ne 1 ]; then
        echo "Frontend failed to become ready"
        exit 1
      fi
    # 6. Run Playwright e2e tests
    - cd $CI_PROJECT_DIR/frontend && CI=1 npm run test:e2e
  artifacts:
    when: always
    paths:
      - frontend/playwright-report/
      - frontend/test-results/

# ==================== PUSH (3 jobs: push to Harbor, main only) ====================

.push-base:
  stage: push
  image:
    name: gcr.io/kaniko-project/executor:v1.23.2-debug
    entrypoint: [""]
  extends: .large-runner
  before_script:
    - mkdir -p /kaniko/.docker
    - AUTH_B64="$(printf '%s:%s' "$HARBOR_USER" "$HARBOR_PASSWORD" | base64 | tr -d '\n')"
    - printf '{"auths":{"%s":{"auth":"%s"}}}\n' "$HARBOR_REGISTRY" "$AUTH_B64" > /kaniko/.docker/config.json
  rules:
    - if: $CI_COMMIT_BRANCH == "main"

push-frontend:
  extends: .push-base
  needs: [build-frontend]
  script:
    - |
      IMAGE_TAG="${CI_COMMIT_SHORT_SHA}"
      /kaniko/executor --context "$CI_PROJECT_DIR" --dockerfile "$CI_PROJECT_DIR/frontend/Dockerfile" --destination "${HARBOR_REGISTRY}/project/frontend:${IMAGE_TAG}" --insecure --skip-tls-verify

push-backend:
  extends: .push-base
  needs: [build-backend]
  script:
    - |
      IMAGE_TAG="${CI_COMMIT_SHORT_SHA}"
      /kaniko/executor --context "$CI_PROJECT_DIR" --dockerfile "$CI_PROJECT_DIR/backend/Dockerfile" --destination "${HARBOR_REGISTRY}/project/backend:${IMAGE_TAG}" --insecure --skip-tls-verify

push-storybook:
  extends: .push-base
  needs: [build-storybook]
  script:
    - |
      IMAGE_TAG="${CI_COMMIT_SHORT_SHA}"
      /kaniko/executor --context "$CI_PROJECT_DIR" --dockerfile "$CI_PROJECT_DIR/frontend/Dockerfile.storybook" --build-arg STORYBOOK_BASE=/storybook/ --destination "${HARBOR_REGISTRY}/project/storybook:${IMAGE_TAG}" --insecure --skip-tls-verify

# ==================== DEPLOY ====================

update-manifests:
  stage: deploy
  tags: [large]
  image: alpine:3.20
  needs: [push-frontend, push-backend, push-storybook]
  before_script:
    - apk add --no-cache git sed
  script:
    - |
      IMAGE_TAG="${CI_COMMIT_SHORT_SHA}"
      KUST="infra/k8s/overlays/production/kustomization.yaml"
      echo "Updating kustomization to registry: ${HARBOR_REGISTRY}, tag: ${IMAGE_TAG}"
      sed -i "s|newName: .*/backend|newName: ${HARBOR_REGISTRY}/project/backend|" "$KUST"
      sed -i "s|newName: .*/frontend|newName: ${HARBOR_REGISTRY}/project/frontend|" "$KUST"
      sed -i "s|newName: .*/storybook|newName: ${HARBOR_REGISTRY}/project/storybook|" "$KUST"
      sed -i "s/newTag: .*/newTag: \"${IMAGE_TAG}\"/" "$KUST"
      cat "$KUST"
      git config user.email "ci@project.dev"
      git config user.name "CI Bot"
      git config http.sslVerify false
      echo "Clone URL from runner: $(git remote get-url origin)"
      ORIGIN_URL="$(git remote get-url origin)"
      if echo "$ORIGIN_URL" | grep -q "github.com"; then
        : "${GITHUB_TOKEN:?GITHUB_TOKEN must be set for GitHub push}"
        CLONE_URL="$(echo "$ORIGIN_URL" | sed "s|https://|https://x-access-token:${GITHUB_TOKEN}@|")"
      else
        CLONE_URL="$(echo "$ORIGIN_URL" | sed "s|://[^@]*@|://gitlab-ci-token:${CI_JOB_TOKEN}@|")"
      fi
      git remote set-url origin "$CLONE_URL"
      echo "Push URL: $(git remote get-url origin | sed 's|://[^@]*@|://***@|')"
      git add "$KUST"
      git commit -m "deploy: update image tag to ${IMAGE_TAG} [skip ci]"
      git push origin HEAD:main
  rules:
    - if: $CI_COMMIT_BRANCH == "main"

# ==================== SMOKE (e2e against deployed instance, nightly + manual) ====================

e2e-smoke:
  stage: smoke
  image: $CI_NODE_PYTHON_IMAGE
  extends: [.large-runner, .retry-infra, .failure-issue, .frontend-cache-readonly]
  variables:
    E2E_BASE_URL: "https://project.senticor.runs.onstackit.cloud"
  before_script:
    - cd frontend && npm ci --ignore-scripts --silent
  script:
    - cd frontend && CI=1 npx playwright test --config e2e/playwright.config.ts --project=smoke
  artifacts:
    when: always
    paths:
      - frontend/playwright-report/
      - frontend/test-results/
    expire_in: 7 days
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
    - when: manual
      allow_failure: true
