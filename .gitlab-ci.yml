include:
  - template: Jobs/SAST.gitlab-ci.yml

stages:
  - quality
  - test
  - build

.default-rules:
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH

.backend-postgres:
  services:
    - name: postgres:16
      alias: postgres
  variables:
    POSTGRES_USER: terminandoyo
    POSTGRES_PASSWORD: ci_test_password
    POSTGRES_DB: terminandoyo
    DATABASE_URL: "postgresql://terminandoyo:ci_test_password@postgres:5432/terminandoyo"
    VITE_API_BASE_URL: "http://localhost:8000"

frontend-lint:
  stage: quality
  image: node:24-bullseye
  extends: .default-rules
  before_script:
    - cd frontend && npm ci --ignore-scripts --silent
  script:
    - npm run lint

frontend-typecheck:
  stage: quality
  image: node:24-bullseye
  extends: .default-rules
  before_script:
    - cd frontend && npm ci --ignore-scripts --silent
  script:
    - npm run type-check

backend-lint:
  stage: quality
  image: python:3.12-slim
  extends: .default-rules
  before_script:
    - pip install -q uv
    - cd backend && uv sync --quiet --all-groups --all-extras
  script:
    - uv run ruff check .

backend-typecheck:
  stage: quality
  image: python:3.12-slim
  extends: .default-rules
  before_script:
    - pip install -q uv
    - cd backend && uv sync --quiet --all-groups --all-extras
  script:
    - uv run mypy app/

frontend-unit:
  stage: test
  image: node:24-bullseye
  extends: .default-rules
  before_script:
    - cd frontend && npm ci --ignore-scripts --silent
  script:
    - CI=1 npx vitest run --project=unit --coverage --coverage.reporter=text --coverage.reporter=cobertura --coverage.reporter=json-summary --coverage.reportsDirectory=coverage/unit
  artifacts:
    when: always
    paths:
      - frontend/coverage/unit/
    reports:
      coverage_report:
        coverage_format: cobertura
        path: frontend/coverage/unit/cobertura-coverage.xml
  coverage: '/All files[^|]*\\|[^|]*\\s([0-9]+(?:\\.[0-9]+)?)\\s/'

backend-unit:
  stage: test
  image: python:3.12-slim
  extends:
    - .default-rules
    - .backend-postgres
  before_script:
    - pip install -q uv
    - cd backend && uv sync --quiet --all-groups --all-extras
    - uv run python -m pip install -q pytest-cov
  script:
    - uv run pytest -q --maxfail=1 --cov=app --cov-report=term-missing --cov-report=xml:coverage/unit.xml --cov-report=html:coverage/unit -k "not integration and not playwright"
  artifacts:
    when: always
    paths:
      - backend/coverage/unit/
    reports:
      coverage_report:
        coverage_format: cobertura
        path: backend/coverage/unit.xml
  coverage: '/TOTAL.*\s+([0-9]+%)$/'

backend-integration:
  stage: test
  image: python:3.12-slim
  extends:
    - .default-rules
    - .backend-postgres
  before_script:
    - pip install -q uv
    - cd backend && uv sync --quiet --all-groups --all-extras
    - uv run python -m pip install -q pytest-cov
  script:
    - uv run pytest -q --maxfail=1 --cov=app --cov-report=term-missing --cov-report=xml:coverage/integration.xml --cov-report=html:coverage/integration -k "integration and not playwright"
  artifacts:
    when: always
    paths:
      - backend/coverage/integration/
    reports:
      coverage_report:
        coverage_format: cobertura
        path: backend/coverage/integration.xml
  coverage: '/TOTAL.*\s+([0-9]+%)$/'

frontend-integration:
  stage: test
  image: python:3.12-slim
  extends:
    - .default-rules
    - .backend-postgres
  before_script:
    - apt-get update -qq && apt-get install -y -qq curl ca-certificates gnupg bash > /dev/null
    - curl -fsSL https://deb.nodesource.com/setup_24.x | bash - > /dev/null
    - apt-get install -y -qq nodejs > /dev/null
    - pip install -q uv
    - cd $CI_PROJECT_DIR/backend && uv sync --quiet --all-groups --all-extras
    - cd $CI_PROJECT_DIR/frontend && npm ci --ignore-scripts --silent
  script:
    - cd $CI_PROJECT_DIR/backend && uv run uvicorn app.main:app --host 0.0.0.0 --port 8000 &
    - |
      BACKEND_READY=0
      for i in $(seq 1 30); do
        if curl -sf http://localhost:8000/schemas > /dev/null 2>&1; then
          echo "Backend is ready"
          BACKEND_READY=1
          break
        fi
        sleep 1
      done
      if [ "$BACKEND_READY" -ne 1 ]; then
        echo "Backend failed to become ready"
        exit 1
      fi
    - cd $CI_PROJECT_DIR/frontend && CI=1 npx vitest run --project=unit -t "JSON Schema contract"

backend-e2e:
  stage: test
  image: python:3.12-slim
  extends:
    - .default-rules
    - .backend-postgres
  before_script:
    - pip install -q uv
    - cd backend && uv sync --quiet --all-groups --all-extras
  script:
    - uv run pytest -q tests/test_flow_playwright.py

frontend-e2e:
  stage: test
  image: python:3.12-slim
  extends:
    - .default-rules
    - .backend-postgres
  before_script:
    - apt-get update -qq && apt-get install -y -qq curl ca-certificates gnupg bash > /dev/null
    - curl -fsSL https://deb.nodesource.com/setup_24.x | bash - > /dev/null
    - apt-get install -y -qq nodejs > /dev/null
    - pip install -q uv
    - cd $CI_PROJECT_DIR/backend && uv sync --quiet --all-groups --all-extras
    - cd $CI_PROJECT_DIR/frontend && npm ci --ignore-scripts --silent
    - npx playwright install --with-deps chromium
  script:
    - cd $CI_PROJECT_DIR/backend && uv run uvicorn app.main:app --host 0.0.0.0 --port 8000 &
    - |
      BACKEND_READY=0
      for i in $(seq 1 30); do
        if curl -sf http://localhost:8000/health > /dev/null 2>&1; then
          echo "Backend is ready"
          BACKEND_READY=1
          break
        fi
        sleep 1
      done
      if [ "$BACKEND_READY" -ne 1 ]; then
        echo "Backend failed to become ready"
        exit 1
      fi
    - cd $CI_PROJECT_DIR/frontend && npm run dev -- --host 0.0.0.0 --port 5173 &
    - |
      FRONTEND_READY=0
      for i in $(seq 1 60); do
        if curl -sf http://localhost:5173 > /dev/null 2>&1; then
          echo "Frontend is ready"
          FRONTEND_READY=1
          break
        fi
        sleep 1
      done
      if [ "$FRONTEND_READY" -ne 1 ]; then
        echo "Frontend failed to become ready"
        exit 1
      fi
    - cd $CI_PROJECT_DIR/frontend && CI=1 npm run test:e2e
  artifacts:
    when: always
    paths:
      - frontend/playwright-report/
      - frontend/test-results/

build-and-push:
  stage: build
  image:
    name: gcr.io/kaniko-project/executor:v1.23.2-debug
    entrypoint: [""]
  before_script:
    - mkdir -p /kaniko/.docker
    - AUTH_B64="$(printf '%s:%s' "$HARBOR_USER" "$HARBOR_PASSWORD" | base64 | tr -d '\n')"
    - printf '{"auths":{"harbor.100-114-108-51.nip.io:30443":{"auth":"%s"}}}\n' "$AUTH_B64" > /kaniko/.docker/config.json
  script:
    - |
      if [ -n "$TAG" ]; then
        IMAGE_TAG="$TAG"
      elif [ "$CI_COMMIT_BRANCH" = "main" ]; then
        IMAGE_TAG="latest"
      else
        IMAGE_TAG="${CI_COMMIT_REF_SLUG}-${CI_COMMIT_SHORT_SHA}"
      fi
      echo "Using image tag: ${IMAGE_TAG}"
      /kaniko/executor --context "$CI_PROJECT_DIR" --dockerfile "$CI_PROJECT_DIR/frontend/Dockerfile" --destination "harbor.100-114-108-51.nip.io:30443/terminandoyo/frontend:${IMAGE_TAG}" --insecure --skip-tls-verify
      /kaniko/executor --context "$CI_PROJECT_DIR" --dockerfile "$CI_PROJECT_DIR/backend/Dockerfile" --destination "harbor.100-114-108-51.nip.io:30443/terminandoyo/backend:${IMAGE_TAG}" --insecure --skip-tls-verify
  extends: .default-rules
