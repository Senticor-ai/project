include:
  - template: Jobs/SAST.gitlab-ci.yml

stages:
  - test
  - build

contract-tests:
  stage: test
  image: python:3.12-slim
  allow_failure: true
  services:
    - name: postgres:16
      alias: postgres
  variables:
    POSTGRES_USER: terminandoyo
    POSTGRES_PASSWORD: ci_test_password
    POSTGRES_DB: terminandoyo
    DATABASE_URL: "postgresql://terminandoyo:ci_test_password@postgres:5432/terminandoyo"
    VITE_API_BASE_URL: "http://localhost:8000"
  before_script:
    - apt-get update -qq && apt-get install -y -qq nodejs npm curl > /dev/null
    - pip install -q uv
    - cd backend && uv sync --quiet
    - cd frontend && npm ci --ignore-scripts --silent
  script:
    - cd backend && uv run uvicorn app.main:app --host 0.0.0.0 --port 8000 &
    - |
      for i in $(seq 1 30); do
        if curl -sf http://localhost:8000/schemas > /dev/null 2>&1; then
          echo "Backend is ready"
          break
        fi
        sleep 1
      done
    - cd frontend && CI=1 npx vitest run --project=unit -t "JSON Schema contract"
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main"

build-and-push:
  stage: build
  image:
    name: gcr.io/kaniko-project/executor:v1.23.2-debug
    entrypoint: [""]
  before_script:
    - mkdir -p /kaniko/.docker
    - AUTH_B64="$(printf '%s:%s' "$HARBOR_USER" "$HARBOR_PASSWORD" | base64 | tr -d '\n')"
    - printf '{"auths":{"harbor.100-114-108-51.nip.io:30443":{"auth":"%s"}}}\n' "$AUTH_B64" > /kaniko/.docker/config.json
  script:
    - IMAGE_TAG="${TAG:-latest}"
    - /kaniko/executor --context "$CI_PROJECT_DIR" --dockerfile "$CI_PROJECT_DIR/frontend/Dockerfile" --destination "harbor.100-114-108-51.nip.io:30443/terminandoyo/frontend:${IMAGE_TAG}" --insecure --skip-tls-verify
    - /kaniko/executor --context "$CI_PROJECT_DIR" --dockerfile "$CI_PROJECT_DIR/backend/Dockerfile" --destination "harbor.100-114-108-51.nip.io:30443/terminandoyo/backend:${IMAGE_TAG}" --insecure --skip-tls-verify
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
